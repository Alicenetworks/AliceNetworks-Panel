import{a7 as W,i as X,a8 as Y,a9 as Z,aa as q}from"./index-ZJAELyGg.js";import{T as G,E as J}from"./TableSkeleton-CpNcW2pL.js";import{u as Q}from"./useKeyboard-CbOLAjL8.js";import{u as ee,f as te,g as F,B as f,e as D}from"./naive-ui-B4L8VU6X.js";import{k as le,o as ae,Z as oe,Y as l,W as o,r as d,V as s,X as g,U as N,N as _,a2 as ne,j as i,m as c}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const se={class:"port-forwards"},ye=le({__name:"PortForwards",setup(re){const u=ee(),V=te(),v=d(!1),k=d(!1),y=d([]),T=d([]),p=d(!1),m=d(null),$=[{label:"TCP",value:"tcp"},{label:"UDP",value:"udp"},{label:"RTCP (可靠 TCP)",value:"rtcp"},{label:"RUDP (可靠 UDP)",value:"rudp"}],x=()=>({name:"",protocol:"tcp",listen_host:"0.0.0.0",listen_port:8080,target_host:"",target_port:80,node_id:null,enabled:!0,description:""}),a=d(x()),h=d([]),E=t=>{const e=$.find(U=>U.value===t);return e?e.label:t.toUpperCase()},M=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"协议",key:"protocol",width:100,render:t=>c(D,{type:"info",size:"small"},()=>E(t.protocol))},{title:"监听",key:"listen",width:200,render:t=>`${t.listen_host||"0.0.0.0"}:${t.listen_port}`},{title:"目标",key:"target",width:200,render:t=>`${t.target_host}:${t.target_port}`},{title:"节点",key:"node_name",width:120,render:t=>t.node_name||"本地"},{title:"状态",key:"enabled",width:80,render:t=>c(D,{type:t.enabled?"success":"default",size:"small"},()=>t.enabled?"启用":"禁用")},{title:"操作",key:"actions",width:150,render:t=>c(F,{size:"small"},()=>[c(f,{size:"small",onClick:()=>j(t)},()=>"编辑"),c(f,{size:"small",type:"error",onClick:()=>I(t)},()=>"删除")])}],C=async()=>{v.value=!0;try{const t=await W();y.value=t||[]}catch{u.error("加载端口转发失败")}finally{v.value=!1}},R=async()=>{try{const t=await X();T.value=t||[],h.value=T.value.map(e=>({label:`${e.name} (${e.host}:${e.port})`,value:e.id}))}catch(t){console.error("Failed to load nodes",t)}},P=()=>{a.value=x(),m.value=null,p.value=!0},j=t=>{m.value=t,a.value={...x(),...t},p.value=!0},z=async()=>{if(!a.value.name){u.error("请输入规则名称");return}if(!a.value.target_host){u.error("请输入目标地址");return}k.value=!0;try{m.value?(await Y(m.value.id,a.value),u.success("转发规则已更新")):(await Z(a.value),u.success("转发规则已创建")),p.value=!1,C()}catch(t){u.error(t.response?.data?.error||"保存转发规则失败")}finally{k.value=!1}},I=t=>{V.warning({title:"删除转发规则",content:`确定要删除转发规则 "${t.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await q(t.id),u.success("转发规则已删除"),C()}catch{u.error("删除转发规则失败")}}})};return ae(()=>{C(),R()}),Q({onNew:P,modalVisible:p,onSave:z}),(t,e)=>{const U=s("n-data-table"),O=s("n-card"),w=s("n-input"),r=s("n-form-item"),S=s("n-select"),b=s("n-divider"),B=s("n-input-number"),A=s("n-text"),H=s("n-switch"),K=s("n-form"),L=s("n-modal");return g(),oe("div",se,[l(O,null,{header:o(()=>[l(_(F),{justify:"space-between",align:"center"},{default:o(()=>[e[12]||(e[12]=ne("span",null,"端口转发",-1)),l(_(f),{type:"primary",onClick:P},{default:o(()=>[...e[11]||(e[11]=[i(" 添加转发规则 ",-1)])]),_:1})]),_:1})]),default:o(()=>[v.value&&y.value.length===0?(g(),N(G,{key:0,rows:3})):!v.value&&y.value.length===0?(g(),N(J,{key:1,type:"forwards","action-text":"添加转发规则",onAction:P})):(g(),N(U,{key:2,columns:M,data:y.value,loading:v.value,"row-key":n=>n.id},null,8,["data","loading","row-key"]))]),_:1}),l(L,{show:p.value,"onUpdate:show":e[10]||(e[10]=n=>p.value=n),preset:"dialog",title:m.value?"编辑转发规则":"添加转发规则",style:{width:"600px"}},{action:o(()=>[l(_(F),null,{default:o(()=>[l(_(f),{onClick:e[9]||(e[9]=n=>p.value=!1)},{default:o(()=>[...e[18]||(e[18]=[i("取消",-1)])]),_:1}),l(_(f),{type:"primary",loading:k.value,onClick:z},{default:o(()=>[...e[19]||(e[19]=[i("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:o(()=>[l(K,{model:a.value,"label-placement":"left","label-width":"120"},{default:o(()=>[l(r,{label:"规则名称"},{default:o(()=>[l(w,{value:a.value.name,"onUpdate:value":e[0]||(e[0]=n=>a.value.name=n),placeholder:"例如: SSH-Forward"},null,8,["value"])]),_:1}),l(r,{label:"协议类型"},{default:o(()=>[l(S,{value:a.value.protocol,"onUpdate:value":e[1]||(e[1]=n=>a.value.protocol=n),options:$},null,8,["value"])]),_:1}),l(b,null,{default:o(()=>[...e[13]||(e[13]=[i("源端配置",-1)])]),_:1}),l(r,{label:"监听地址"},{default:o(()=>[l(w,{value:a.value.listen_host,"onUpdate:value":e[2]||(e[2]=n=>a.value.listen_host=n),placeholder:"0.0.0.0 或留空"},null,8,["value"])]),_:1}),l(r,{label:"监听端口"},{default:o(()=>[l(B,{value:a.value.listen_port,"onUpdate:value":e[3]||(e[3]=n=>a.value.listen_port=n),min:1,max:65535,style:{width:"150px"}},null,8,["value"])]),_:1}),l(b,null,{default:o(()=>[...e[14]||(e[14]=[i("目标端配置",-1)])]),_:1}),l(r,{label:"目标地址"},{default:o(()=>[l(w,{value:a.value.target_host,"onUpdate:value":e[4]||(e[4]=n=>a.value.target_host=n),placeholder:"目标主机 IP 或域名"},null,8,["value"])]),_:1}),l(r,{label:"目标端口"},{default:o(()=>[l(B,{value:a.value.target_port,"onUpdate:value":e[5]||(e[5]=n=>a.value.target_port=n),min:1,max:65535,style:{width:"150px"}},null,8,["value"])]),_:1}),l(b,null,{default:o(()=>[...e[15]||(e[15]=[i("转发节点",-1)])]),_:1}),l(r,{label:"选择节点"},{default:o(()=>[l(S,{value:a.value.node_id,"onUpdate:value":e[6]||(e[6]=n=>a.value.node_id=n),options:h.value,filterable:"",placeholder:"选择执行转发的节点",clearable:""},null,8,["value","options"]),l(A,{depth:"3",style:{"margin-top":"4px","font-size":"12px"}},{default:o(()=>[...e[16]||(e[16]=[i("留空表示在本地执行转发",-1)])]),_:1})]),_:1}),l(b,null,{default:o(()=>[...e[17]||(e[17]=[i("其他选项",-1)])]),_:1}),l(r,{label:"启用"},{default:o(()=>[l(H,{value:a.value.enabled,"onUpdate:value":e[7]||(e[7]=n=>a.value.enabled=n)},null,8,["value"])]),_:1}),l(r,{label:"描述"},{default:o(()=>[l(w,{value:a.value.description,"onUpdate:value":e[8]||(e[8]=n=>a.value.description=n),type:"textarea",placeholder:"转发规则描述",autosize:{minRows:2}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}});export{ye as default};
