import{i as Q}from"./echarts-HRpVOA9p.js";import{h as Ne,i as Ce,j as Oe}from"./index-ZJAELyGg.js";import{k as ue,X as D,Z as fe,a2 as r,r as i,o as Be,n as Te,E as Le,Y as e,W as t,V as p,N as f,j as S,a4 as I,U as ee,_ as Pe,m as ze}from"./vue-vendor-CGi32OHI.js";import{a as ie,b as Me,c as Re,e as te}from"./naive-ui-B4L8VU6X.js";import{N as re,S as Ie,D as De}from"./ServerOutline-CH8la6EY.js";import{R as Ue}from"./RefreshOutline-BlwU_6pp.js";import{_ as We}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-3OKNQTir.js";const $e={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ce=ue({name:"CheckmarkCircleOutline",render:function(N,T){return D(),fe("svg",$e,T[0]||(T[0]=[r("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),r("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M352 176L217.6 336L160 272"},null,-1)]))}}),B=i("default"),E=new Set,Ae=300*1e3,Ee=()=>document.querySelector('link[rel="icon"]')?.href||"/vite.svg";function Fe(){const U=async()=>{if(!("Notification"in window))return!1;if(Notification.permission==="granted")return B.value="granted",!0;if(Notification.permission!=="denied"){const n=await Notification.requestPermission();return B.value=n,n==="granted"}return!1},N=(n,_)=>{if(B.value!=="granted")return null;const C=Ee(),m=new Notification(n,{icon:C,badge:C,..._});return m.onclick=()=>{window.focus(),m.close()},m};return{notificationPermission:B,requestPermission:U,showNotification:N,notifyNodeOffline:(n,_)=>{E.has(n)||(E.add(n),N("节点离线告警",{body:`节点 "${_}" 已离线`,tag:`node-offline-${n}`,requireInteraction:!0}),setTimeout(()=>{E.delete(n)},Ae))},notifyNodeOnline:(n,_)=>{E.delete(n),N("节点恢复上线",{body:`节点 "${_}" 已恢复上线`,tag:`node-online-${n}`})},checkPermission:()=>("Notification"in window&&(B.value=Notification.permission),B.value)}}const qe={class:"dashboard"},He={class:"stat-row"},Ve={class:"value"},je={class:"stat-row"},Ge={class:"value"},Je={class:"stat-row"},Ke={class:"value highlight"},Xe=ue({__name:"Dashboard",setup(U){const{requestPermission:N,notifyNodeOffline:T,notifyNodeOnline:oe,checkPermission:le}=Fe(),n=i(!1),_=i(!1),C=i(!1),m=i(!0),F=i(1e4),L=i(null),q=i(1),H=i(null),V=i(null),j=i(null),G=i(!1);let W=null,b=null,w=null,x=null,g=null,O=null,P=null;const de=[{label:"5s",value:5e3},{label:"10s",value:1e4},{label:"30s",value:3e4},{label:"60s",value:6e4}],ve=[{label:"1 小时",value:1},{label:"6 小时",value:6},{label:"12 小时",value:12},{label:"24 小时",value:24}],c=i({total_nodes:0,online_nodes:0,total_clients:0,online_clients:0,total_traffic_in:0,total_traffic_out:0,total_connections:0}),k=i([]),z=i([]),pe=[{title:"名称",key:"name",width:120},{title:"地址",key:"host",ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:100,render:l=>ze(te,{type:l.status==="online"?"success":"default",size:"small"},()=>l.status==="online"?"在线":"离线")},{title:"连接数",key:"connections",width:100},{title:"入站流量",key:"traffic_in",width:120,render:l=>$(l.traffic_in)},{title:"出站流量",key:"traffic_out",width:120,render:l=>$(l.traffic_out)}],$=l=>{if(l===0)return"0 B";const o=1024,s=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(l)/Math.log(o));return parseFloat((l/Math.pow(o,a)).toFixed(2))+" "+s[a]},_e=l=>l.toLocaleTimeString(),me=async()=>{_.value=!0;try{const l=await Ne();c.value=l,L.value=new Date,J()}catch(l){console.error("Failed to load stats",l)}finally{_.value=!1}},ge=async()=>{C.value=!0;try{const l=await Ce();k.value=l}catch(l){console.error("Failed to load nodes",l)}finally{C.value=!1}},ae=async()=>{try{const l=await Oe(q.value);z.value=l||[],ne()}catch(l){console.error("Failed to load traffic history",l)}},ye=()=>{H.value&&(b=Q(H.value),ne(),P=()=>{b?.resize(),w?.resize(),x?.resize()},window.addEventListener("resize",P))},he=()=>{V.value&&(w=Q(V.value)),j.value&&(x=Q(j.value)),J()},J=()=>{const l=c.value.online_nodes,o=c.value.total_nodes-l,s=c.value.online_clients,a=c.value.total_clients-s,v=(u,R,d)=>({backgroundColor:"transparent",tooltip:{trigger:"item",backgroundColor:"rgba(15, 21, 53, 0.95)",borderColor:"rgba(255, 255, 255, 0.1)",textStyle:{color:"#ffffff"},formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",right:"5%",top:"center",textStyle:{color:"rgba(255, 255, 255, 0.7)"}},series:[{name:d,type:"pie",radius:["45%","70%"],center:["35%","50%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:6,borderColor:"rgba(0, 0, 0, 0.3)",borderWidth:2},label:{show:!0,position:"center",formatter:()=>`${u}/${u+R}`,fontSize:18,fontWeight:"bold",color:"#fff"},emphasis:{label:{show:!0,fontSize:20,fontWeight:"bold"}},data:[{value:u,name:"在线",itemStyle:{color:"#22c55e"}},{value:R,name:"离线",itemStyle:{color:"#6b7280"}}]}]});w&&w.setOption(v(l,o,"节点状态")),x&&x.setOption(v(s,a,"客户端状态"))},ne=()=>{if(!b)return;const l=z.value.map(u=>new Date(u.time).toLocaleTimeString()),o=z.value.map(u=>u.traffic_in/(1024*1024)),s=z.value.map(u=>u.traffic_out/(1024*1024)),a=z.value.map(u=>u.connections),v={backgroundColor:"transparent",tooltip:{trigger:"axis",backgroundColor:"rgba(15, 21, 53, 0.95)",borderColor:"rgba(255, 255, 255, 0.1)",borderWidth:1,textStyle:{color:"#ffffff"},axisPointer:{type:"cross",lineStyle:{color:"rgba(255, 255, 255, 0.2)"}}},legend:{data:["入站流量 (MB)","出站流量 (MB)","连接数"],textStyle:{color:"rgba(255, 255, 255, 0.7)"},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"40px",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:l,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"}},yAxis:[{type:"value",name:"流量 (MB)",position:"left",nameTextStyle:{color:"rgba(255, 255, 255, 0.5)"},axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.05)"}}},{type:"value",name:"连接数",position:"right",nameTextStyle:{color:"rgba(255, 255, 255, 0.5)"},axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"},splitLine:{show:!1}}],series:[{name:"入站流量 (MB)",type:"line",smooth:!0,data:o,itemStyle:{color:"#22c55e"},lineStyle:{width:2,shadowColor:"rgba(34, 197, 94, 0.3)",shadowBlur:10},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(34, 197, 94, 0.3)"},{offset:1,color:"rgba(34, 197, 94, 0.02)"}]}}},{name:"出站流量 (MB)",type:"line",smooth:!0,data:s,itemStyle:{color:"#3b82f6"},lineStyle:{width:2,shadowColor:"rgba(59, 130, 246, 0.3)",shadowBlur:10},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(59, 130, 246, 0.3)"},{offset:1,color:"rgba(59, 130, 246, 0.02)"}]}}},{name:"连接数",type:"line",smooth:!0,yAxisIndex:1,data:a,itemStyle:{color:"#f59e0b"},lineStyle:{width:2,shadowColor:"rgba(245, 158, 11, 0.3)",shadowBlur:10}}]};b.setOption(v)},K=async()=>{await Promise.all([me(),ge(),ae()])},X=()=>{Y(),m.value&&(W=setInterval(K,F.value))},Y=()=>{W&&(clearInterval(W),W=null)},be=l=>{l?X():Y()},we=()=>{m.value&&X()},xe=async l=>{l?await N()?localStorage.setItem("notificationsEnabled","true"):n.value=!1:localStorage.setItem("notificationsEnabled","false")};let M=!1;const se=()=>{if(M)return;const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;try{g=new WebSocket(o)}catch{return}g.onopen=()=>{M||(G.value=!0)},g.onmessage=s=>{if(!M)try{const a=JSON.parse(s.data);ke(a)}catch{}},g.onclose=()=>{M||(G.value=!1,O&&clearTimeout(O),O=setTimeout(se,5e3))},g.onerror=()=>{g?.close()}},ke=l=>{switch(l.type){case"node_status":const o=l.data,s=k.value.findIndex(a=>a.id===o.node_id);if(s!==-1){const a=k.value[s].status,v=k.value[s].name;k.value[s]={...k.value[s],status:o.status,connections:o.connections,traffic_in:o.traffic_in,traffic_out:o.traffic_out},n.value&&a!==o.status&&(o.status==="offline"?T(o.node_id,v):o.status==="online"&&a==="offline"&&oe(o.node_id,v))}L.value=new Date;break;case"stats":c.value=l.data,L.value=new Date,J();break}};return Be(()=>{K(),Te(()=>{ye(),he()}),X(),se(),localStorage.getItem("notificationsEnabled")==="true"&&le()==="granted"&&(n.value=!0)}),Le(()=>{M=!0,Y(),P&&(window.removeEventListener("resize",P),P=null),O&&(clearTimeout(O),O=null),b&&(b.dispose(),b=null),w&&(w.dispose(),w=null),x&&(x.dispose(),x=null),g&&(g.close(),g=null)}),(l,o)=>{const s=p("n-select"),a=p("n-icon"),v=p("n-space"),u=p("n-text"),R=p("n-button"),d=p("n-card"),A=p("n-statistic"),y=p("n-grid-item"),Z=p("n-grid"),Se=p("n-data-table");return D(),fe("div",qe,[e(d,{class:"mb-4"},{default:t(()=>[e(v,{justify:"space-between",align:"center"},{default:t(()=>[e(v,{align:"center"},{default:t(()=>[e(f(ie),{value:m.value,"onUpdate:value":[o[0]||(o[0]=h=>m.value=h),be]},{checked:t(()=>[...o[4]||(o[4]=[S("自动刷新",-1)])]),unchecked:t(()=>[...o[5]||(o[5]=[S("自动刷新",-1)])]),_:1},8,["value"]),e(s,{value:F.value,"onUpdate:value":[o[1]||(o[1]=h=>F.value=h),we],options:de,disabled:!m.value,style:{width:"120px"}},null,8,["value","disabled"]),e(f(Me),{vertical:""}),e(f(Re),{trigger:"hover"},{trigger:t(()=>[e(f(ie),{value:n.value,"onUpdate:value":[o[2]||(o[2]=h=>n.value=h),xe]},{checked:t(()=>[e(a,null,{default:t(()=>[e(f(re))]),_:1})]),unchecked:t(()=>[e(a,null,{default:t(()=>[e(f(re))]),_:1})]),_:1},8,["value"])]),default:t(()=>[S(" "+I(n.value?"浏览器通知已开启":"点击开启浏览器通知"),1)]),_:1})]),_:1}),e(v,{align:"center"},{default:t(()=>[G.value?(D(),ee(f(te),{key:0,type:"success",size:"small"},{default:t(()=>[...o[6]||(o[6]=[S(" 实时 ",-1)])]),_:1})):(D(),ee(f(te),{key:1,type:"default",size:"small"},{default:t(()=>[...o[7]||(o[7]=[S(" 离线 ",-1)])]),_:1})),L.value?(D(),ee(u,{key:2,depth:"3"},{default:t(()=>[S(" 更新时间: "+I(_e(L.value)),1)]),_:1})):Pe("",!0),e(R,{loading:_.value,onClick:K},{icon:t(()=>[e(a,null,{default:t(()=>[e(f(Ue))]),_:1})]),default:t(()=>[o[8]||(o[8]=S(" 刷新 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),e(Z,{"x-gap":16,"y-gap":16,cols:4},{default:t(()=>[e(y,null,{default:t(()=>[e(d,null,{default:t(()=>[e(A,{label:"节点总数",value:c.value.total_nodes},{prefix:t(()=>[e(a,null,{default:t(()=>[e(f(Ie))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(d,null,{default:t(()=>[e(A,{label:"在线节点",value:c.value.online_nodes},{prefix:t(()=>[e(a,{color:"#18a058"},{default:t(()=>[e(f(ce))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(d,null,{default:t(()=>[e(A,{label:"客户端总数",value:c.value.total_clients},{prefix:t(()=>[e(a,null,{default:t(()=>[e(f(De))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(d,null,{default:t(()=>[e(A,{label:"在线客户端",value:c.value.online_clients},{prefix:t(()=>[e(a,{color:"#18a058"},{default:t(()=>[e(f(ce))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(Z,{"x-gap":16,"y-gap":16,cols:2,class:"mt-4"},{default:t(()=>[e(y,null,{default:t(()=>[e(d,{title:"节点状态分布"},{default:t(()=>[r("div",{ref_key:"nodePieRef",ref:V,style:{height:"200px"}},null,512)]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(d,{title:"客户端状态分布"},{default:t(()=>[r("div",{ref_key:"clientPieRef",ref:j,style:{height:"200px"}},null,512)]),_:1})]),_:1})]),_:1}),e(d,{title:"流量趋势",class:"mt-4"},{"header-extra":t(()=>[e(s,{value:q.value,"onUpdate:value":[o[3]||(o[3]=h=>q.value=h),ae],options:ve,style:{width:"100px"},size:"small"},null,8,["value"])]),default:t(()=>[r("div",{ref_key:"chartRef",ref:H,style:{height:"300px"}},null,512)]),_:1}),e(d,{title:"流量统计",class:"mt-4"},{default:t(()=>[e(Z,{"x-gap":24,cols:3},{default:t(()=>[e(y,null,{default:t(()=>[r("div",He,[o[9]||(o[9]=r("span",{class:"label"},"入站流量",-1)),r("span",Ve,I($(c.value.total_traffic_in)),1)])]),_:1}),e(y,null,{default:t(()=>[r("div",je,[o[10]||(o[10]=r("span",{class:"label"},"出站流量",-1)),r("span",Ge,I($(c.value.total_traffic_out)),1)])]),_:1}),e(y,null,{default:t(()=>[r("div",Je,[o[11]||(o[11]=r("span",{class:"label"},"当前连接",-1)),r("span",Ke,I(c.value.total_connections),1)])]),_:1})]),_:1})]),_:1}),e(d,{title:"节点状态",class:"mt-4"},{default:t(()=>[e(Se,{columns:pe,data:k.value,loading:C.value,"row-key":h=>h.id,size:"small","max-height":300},null,8,["data","loading","row-key"])]),_:1})])}}}),nt=We(Xe,[["__scopeId","data-v-7fbe1841"]]);export{nt as default};
