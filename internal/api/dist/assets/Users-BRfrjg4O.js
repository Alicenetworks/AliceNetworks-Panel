import{O as be,P as ke,Q as Pe,R as xe,S as Ue,e as Ce,T as qe,U as he,V as ze,W as $e,X as Me,Y as Te}from"./index-ZJAELyGg.js";import{T as Be,E as De}from"./TableSkeleton-CpNcW2pL.js";import{u as Ne}from"./useKeyboard-CbOLAjL8.js";import{u as Se,f as Ve,g,B as d,b as ae,q as Ee,r as V,e as z,o as Ie,c as le}from"./naive-ui-B4L8VU6X.js";import{k as Re,o as Fe,Z as E,Y as l,W as t,r as y,V as k,X as m,U as b,N as r,a2 as I,j as v,_ as P,a4 as $,F as te,I as Oe,c as W,m as i}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const je={class:"users"},Ae={key:1,style:{color:"#999"}},ea=Re({__name:"Users",setup(Ge){const s=Se(),R=Ve(),B=y(!1),F=y(!1),O=y(!1),N=y([]),q=y(!1),D=y(!1),h=y(!1),f=y(null),u=y(null),X=y([]),M=y(null),T=y(30),ne=W(()=>X.value.map(e=>({label:`${e.name} (${x(e.traffic_quota)} / ${e.duration}天)`,value:e.id}))),j=W(()=>u.value?.plan_expire_at?new Date(u.value.plan_expire_at)<new Date:!1),se=[{label:"管理员",value:"admin"},{label:"普通用户",value:"user"},{label:"只读用户",value:"viewer"}],A=()=>({username:"",password:"",role:"user",email:"",enabled:!0,email_verified:!0,traffic_quota:0,quota_reset_day:1}),o=y(A()),Y=W({get:()=>{const e=o.value.traffic_quota||0;return Math.round(e/(1024*1024*1024))},set:e=>{o.value.traffic_quota=e*1024*1024*1024}}),p=y({oldPassword:"",newPassword:"",confirmPassword:""}),S=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",re=e=>({admin:"管理员",user:"普通用户",viewer:"只读用户"})[e]||e,x=e=>{if(!e||e===0)return"0 B";const a=["B","KB","MB","GB","TB"];let w=0,_=e;for(;_>=1024&&w<a.length-1;)_/=1024,w++;return`${_.toFixed(w===0?0:2)} ${a[w]}`},ue=Array.from({length:28},(e,a)=>({label:`每月 ${a+1} 日`,value:a+1})),oe=[{title:"ID",key:"id",width:60},{title:"用户名",key:"username",width:120},{title:"邮箱",key:"email",ellipsis:{tooltip:!0},render:e=>e.email?i(g,{size:"small",align:"center"},()=>[e.email,e.email_verified?i(z,{type:"success",size:"tiny"},()=>"已验证"):i(z,{type:"warning",size:"tiny"},()=>"未验证")]):"-"},{title:"角色",key:"role",width:100,render:e=>i(z,{type:{admin:"error",user:"success",viewer:"info"}[e.role]||"default",size:"small"},()=>re(e.role))},{title:"流量配额",key:"traffic_quota",width:180,render:e=>{if(!e.traffic_quota||e.traffic_quota===0)return i(z,{type:"default",size:"small"},()=>"无限制");const a=e.quota_used||0,w=e.traffic_quota,_=Math.min(a/w*100,100),C=e.quota_exceeded;return i(g,{vertical:!0,size:2},()=>[i("div",{style:{fontSize:"12px"}},`${x(a)} / ${x(w)}`),i(Ie,{type:"line",percentage:_,status:C?"error":_>80?"warning":"success",height:6,showIndicator:!1})])}},{title:"套餐",key:"plan",width:150,render:e=>{if(!e.plan)return i(d,{size:"tiny",onClick:()=>H(e)},()=>"分配套餐");const a=e.plan,w=e.plan_expire_at&&new Date(e.plan_expire_at)<new Date;return i(le,{},{trigger:()=>i(g,{size:"small",align:"center"},()=>[i(z,{type:w?"error":"info",size:"small"},()=>a.name),i(d,{size:"tiny",quaternary:!0,onClick:()=>H(e)},()=>"管理")]),default:()=>{const _=[`套餐: ${a.name}`];return e.plan_expire_at&&_.push(`到期: ${S(e.plan_expire_at)}`),a.traffic_quota>0&&_.push(`流量: ${x(e.plan_traffic_used||0)} / ${x(a.traffic_quota)}`),_.join(`
`)}})}},{title:"状态",key:"enabled",width:80,render:e=>i(z,{type:e.enabled!==!1?"success":"default",size:"small"},()=>e.enabled!==!1?"启用":"禁用")},{title:"创建时间",key:"created_at",width:150,render:e=>S(e.created_at)},{title:"最后登录",key:"last_login_at",width:150,render:e=>e.last_login_at?i(le,{},{trigger:()=>S(e.last_login_at),default:()=>`IP: ${e.last_login_ip||"未知"}`}):"-"},{title:"操作",key:"actions",width:200,render:e=>i(g,{size:"small"},()=>[i(d,{size:"small",onClick:()=>ie(e)},()=>"编辑"),!e.email_verified&&e.email?i(d,{size:"small",type:"info",onClick:()=>ve(e)},()=>"验证"):null,!e.email_verified&&e.email?i(d,{size:"small",type:"warning",onClick:()=>pe(e)},()=>"重发"):null,i(d,{size:"small",type:"error",onClick:()=>de(e),disabled:e.username==="admin"},()=>"删除")])}],U=async()=>{B.value=!0;try{const e=await ke();N.value=e||[]}catch{s.error("加载用户失败")}finally{B.value=!1}},G=()=>{o.value=A(),f.value=null,q.value=!0},ie=e=>{f.value=e,o.value={...A(),...e,password:"",enabled:e.enabled!==!1,email_verified:e.email_verified||!1,traffic_quota:e.traffic_quota||0,quota_reset_day:e.quota_reset_day||1},q.value=!0},Z=async()=>{if(!o.value.username){s.error("请输入用户名");return}if(!f.value&&!o.value.password){s.error("请输入密码");return}F.value=!0;try{f.value?(await Pe(f.value.id,o.value),s.success("用户已更新")):(await xe(o.value),s.success("用户已创建")),q.value=!1,U()}catch(e){s.error(e.response?.data?.error||"保存用户失败")}finally{F.value=!1}},de=e=>{if(e.username==="admin"){s.error("不能删除管理员账号");return}R.warning({title:"删除用户",content:`确定要删除用户 "${e.username}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await he(e.id),s.success("用户已删除"),U()}catch{s.error("删除用户失败")}}})},ve=async e=>{try{await ze(e.id),s.success("邮箱已验证"),U()}catch(a){s.error(a.response?.data?.error||"验证失败")}},pe=async e=>{try{await $e(e.id),s.success("验证邮件已发送")}catch(a){s.error(a.response?.data?.error||"发送失败")}},fe=async()=>{f.value&&R.warning({title:"重置配额",content:`确定要重置用户 "${f.value.username}" 的已用流量吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{await Ue(f.value.id),s.success("配额已重置"),U(),f.value.quota_used=0,f.value.quota_exceeded=!1}catch(e){s.error(e.response?.data?.error||"重置失败")}}})},me=()=>{p.value={oldPassword:"",newPassword:"",confirmPassword:""},D.value=!0},ce=async()=>{if(!p.value.oldPassword||!p.value.newPassword||!p.value.confirmPassword){s.error("请填写所有字段");return}if(p.value.newPassword!==p.value.confirmPassword){s.error("两次输入的新密码不一致");return}if(p.value.newPassword.length<6){s.error("密码长度至少为 6 位");return}O.value=!0;try{await Ce(p.value.oldPassword,p.value.newPassword),s.success("密码已修改"),D.value=!1}catch(e){s.error(e.response?.data?.error||"修改密码失败")}finally{O.value=!1}};Fe(()=>{U(),ye()});const ye=async()=>{try{const e=await be();X.value=(e||[]).filter(a=>a.enabled)}catch(e){console.error("加载套餐失败",e)}},H=e=>{u.value=e,M.value=e.plan_id||null,T.value=e.plan?.duration||30,h.value=!0},_e=async()=>{if(!u.value||!M.value){s.error("请选择套餐");return}try{await qe(u.value.id,M.value),s.success("套餐已分配"),h.value=!1,U()}catch(e){s.error(e.response?.data?.error||"分配套餐失败")}},we=async()=>{u.value&&R.warning({title:"移除套餐",content:`确定要移除用户 "${u.value.username}" 的套餐吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{await Me(u.value.id),s.success("套餐已移除"),h.value=!1,U()}catch(e){s.error(e.response?.data?.error||"移除套餐失败")}}})},ge=async()=>{if(!u.value||T.value<=0){s.error("请输入续期天数");return}try{await Te(u.value.id,T.value),s.success(`已续期 ${T.value} 天`),h.value=!1,U()}catch(e){s.error(e.response?.data?.error||"续期失败")}};return Ne({onNew:G,modalVisible:q,onSave:Z}),(e,a)=>{const w=k("n-data-table"),_=k("n-card"),C=k("n-input"),c=k("n-form-item"),Q=k("n-select"),J=k("n-switch"),ee=k("n-input-number"),K=k("n-form"),L=k("n-modal");return m(),E("div",je,[l(_,null,{header:t(()=>[l(r(g),{justify:"space-between",align:"center"},{default:t(()=>[a[21]||(a[21]=I("span",null,"用户管理",-1)),l(r(g),null,{default:t(()=>[l(r(d),{type:"primary",onClick:G},{default:t(()=>[...a[19]||(a[19]=[v(" 添加用户 ",-1)])]),_:1}),l(r(d),{onClick:me},{default:t(()=>[...a[20]||(a[20]=[v(" 修改密码 ",-1)])]),_:1})]),_:1})]),_:1})]),default:t(()=>[B.value&&N.value.length===0?(m(),b(Be,{key:0,rows:3,columns:[1,2,1,1,2]})):!B.value&&N.value.length===0?(m(),b(De,{key:1,type:"users","action-text":"添加用户",onAction:G})):(m(),b(w,{key:2,columns:oe,data:N.value,loading:B.value,"row-key":n=>n.id},null,8,["data","loading","row-key"]))]),_:1}),l(L,{show:q.value,"onUpdate:show":a[9]||(a[9]=n=>q.value=n),preset:"dialog",title:f.value?"编辑用户":"添加用户",style:{width:"550px"}},{action:t(()=>[l(r(g),null,{default:t(()=>[l(r(d),{onClick:a[8]||(a[8]=n=>q.value=!1)},{default:t(()=>[...a[25]||(a[25]=[v("取消",-1)])]),_:1}),l(r(d),{type:"primary",loading:F.value,onClick:Z},{default:t(()=>[...a[26]||(a[26]=[v("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:t(()=>[l(K,{model:o.value,"label-placement":"left","label-width":"100"},{default:t(()=>[l(c,{label:"用户名"},{default:t(()=>[l(C,{value:o.value.username,"onUpdate:value":a[0]||(a[0]=n=>o.value.username=n),placeholder:"用户名",disabled:!!f.value},null,8,["value","disabled"])]),_:1}),f.value?P("",!0):(m(),b(c,{key:0,label:"密码"},{default:t(()=>[l(C,{value:o.value.password,"onUpdate:value":a[1]||(a[1]=n=>o.value.password=n),type:"password",placeholder:"密码","show-password-on":"click"},null,8,["value"])]),_:1})),l(c,{label:"角色"},{default:t(()=>[l(Q,{value:o.value.role,"onUpdate:value":a[2]||(a[2]=n=>o.value.role=n),options:se},null,8,["value"])]),_:1}),l(c,{label:"邮箱"},{default:t(()=>[l(C,{value:o.value.email,"onUpdate:value":a[3]||(a[3]=n=>o.value.email=n),placeholder:"user@example.com"},null,8,["value"])]),_:1}),l(c,{label:"启用账户"},{default:t(()=>[l(J,{value:o.value.enabled,"onUpdate:value":a[4]||(a[4]=n=>o.value.enabled=n)},null,8,["value"])]),_:1}),l(c,{label:"邮箱已验证"},{default:t(()=>[l(J,{value:o.value.email_verified,"onUpdate:value":a[5]||(a[5]=n=>o.value.email_verified=n)},null,8,["value"])]),_:1}),l(r(ae),{"title-placement":"left"},{default:t(()=>[...a[22]||(a[22]=[v("流量配额",-1)])]),_:1}),l(c,{label:"流量限制"},{default:t(()=>[l(r(g),null,{default:t(()=>[l(ee,{value:Y.value,"onUpdate:value":a[6]||(a[6]=n=>Y.value=n),min:0,max:10240,step:1,style:{width:"120px"},placeholder:"0"},null,8,["value"]),a[23]||(a[23]=I("span",null,"GB (0 = 无限制)",-1))]),_:1})]),_:1}),l(c,{label:"重置日期"},{default:t(()=>[l(Q,{value:o.value.quota_reset_day,"onUpdate:value":a[7]||(a[7]=n=>o.value.quota_reset_day=n),options:r(ue),style:{width:"150px"}},null,8,["value","options"])]),_:1}),f.value?(m(),b(c,{key:1,label:"已用流量"},{default:t(()=>[l(r(g),{align:"center"},{default:t(()=>[I("span",null,$(x(f.value.quota_used||0)),1),l(r(d),{size:"small",type:"warning",onClick:fe},{default:t(()=>[...a[24]||(a[24]=[v("重置",-1)])]),_:1})]),_:1})]),_:1})):P("",!0)]),_:1},8,["model"])]),_:1},8,["show","title"]),l(L,{show:D.value,"onUpdate:show":a[14]||(a[14]=n=>D.value=n),preset:"dialog",title:"修改密码",style:{width:"500px"}},{action:t(()=>[l(r(g),null,{default:t(()=>[l(r(d),{onClick:a[13]||(a[13]=n=>D.value=!1)},{default:t(()=>[...a[27]||(a[27]=[v("取消",-1)])]),_:1}),l(r(d),{type:"primary",loading:O.value,onClick:ce},{default:t(()=>[...a[28]||(a[28]=[v("确认",-1)])]),_:1},8,["loading"])]),_:1})]),default:t(()=>[l(K,{model:p.value,"label-placement":"left","label-width":"100"},{default:t(()=>[l(c,{label:"旧密码"},{default:t(()=>[l(C,{value:p.value.oldPassword,"onUpdate:value":a[10]||(a[10]=n=>p.value.oldPassword=n),type:"password",placeholder:"输入旧密码","show-password-on":"click"},null,8,["value"])]),_:1}),l(c,{label:"新密码"},{default:t(()=>[l(C,{value:p.value.newPassword,"onUpdate:value":a[11]||(a[11]=n=>p.value.newPassword=n),type:"password",placeholder:"输入新密码","show-password-on":"click"},null,8,["value"])]),_:1}),l(c,{label:"确认密码"},{default:t(()=>[l(C,{value:p.value.confirmPassword,"onUpdate:value":a[12]||(a[12]=n=>p.value.confirmPassword=n),type:"password",placeholder:"再次输入新密码","show-password-on":"click"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"]),l(L,{show:h.value,"onUpdate:show":a[18]||(a[18]=n=>h.value=n),preset:"dialog",title:"套餐管理",style:{width:"500px"}},{action:t(()=>[l(r(g),null,{default:t(()=>[l(r(d),{onClick:a[17]||(a[17]=n=>h.value=!1)},{default:t(()=>[...a[30]||(a[30]=[v("取消",-1)])]),_:1}),u.value?.plan?(m(),b(r(d),{key:0,type:"warning",onClick:ge},{default:t(()=>[...a[31]||(a[31]=[v(" 续期 ",-1)])]),_:1})):P("",!0),u.value?.plan?(m(),b(r(d),{key:1,type:"error",onClick:we},{default:t(()=>[...a[32]||(a[32]=[v(" 移除套餐 ",-1)])]),_:1})):P("",!0),l(r(d),{type:"primary",onClick:_e,disabled:!M.value},{default:t(()=>[v($(u.value?.plan?"更换套餐":"分配套餐"),1)]),_:1},8,["disabled"])]),_:1})]),default:t(()=>[u.value?(m(),E(te,{key:0},[l(r(Ee),{column:1,"label-placement":"left",bordered:"",size:"small",style:{"margin-bottom":"16px"}},{default:t(()=>[l(r(V),{label:"用户"},{default:t(()=>[v($(u.value.username),1)]),_:1}),l(r(V),{label:"当前套餐"},{default:t(()=>[u.value.plan?(m(),b(r(z),{key:0,type:j.value?"error":"info",size:"small"},{default:t(()=>[v($(u.value.plan.name)+" ",1),j.value?(m(),E(te,{key:0},[v(" (已过期)")],64)):P("",!0)]),_:1},8,["type"])):(m(),E("span",Ae,"未分配"))]),_:1}),u.value.plan_expire_at?(m(),b(r(V),{key:0,label:"到期时间"},{default:t(()=>[I("span",{style:Oe({color:j.value?"#e88080":"inherit"})},$(S(u.value.plan_expire_at)),5)]),_:1})):P("",!0),u.value.plan&&u.value.plan.traffic_quota>0?(m(),b(r(V),{key:1,label:"流量使用"},{default:t(()=>[v($(x(u.value.plan_traffic_used||0))+" / "+$(x(u.value.plan.traffic_quota)),1)]),_:1})):P("",!0)]),_:1}),l(r(ae),{"title-placement":"left",style:{margin:"16px 0"}},{default:t(()=>[...a[29]||(a[29]=[v("操作",-1)])]),_:1}),l(K,{"label-placement":"left","label-width":"80"},{default:t(()=>[l(c,{label:"选择套餐"},{default:t(()=>[l(Q,{value:M.value,"onUpdate:value":a[15]||(a[15]=n=>M.value=n),options:ne.value,placeholder:"请选择套餐",clearable:""},null,8,["value","options"])]),_:1}),u.value.plan?(m(),b(c,{key:0,label:"续期天数"},{default:t(()=>[l(ee,{value:T.value,"onUpdate:value":a[16]||(a[16]=n=>T.value=n),min:1,max:3650,style:{width:"150px"}},null,8,["value"])]),_:1})):P("",!0)]),_:1})],64)):P("",!0)]),_:1},8,["show"])])}}});export{ea as default};
