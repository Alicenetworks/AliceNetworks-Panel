import{aI as ge,aJ as we,aK as ke,i as he,aL as _e,aM as be,aN as xe,aO as Te,aP as Ce,aQ as $e,aR as ze,aS as Ae,aT as Ie}from"./index-ZJAELyGg.js";import{E as Z,T as G}from"./TableSkeleton-CpNcW2pL.js";import{u as Me,f as Be,g as _,B as p,e as P}from"./naive-ui-B4L8VU6X.js";import{k as Ne,o as Ue,Z as Pe,Y as a,W as l,r as o,V as c,X as w,j as r,N as m,U as b,a2 as Se,c as De,m as v}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const He={class:"rules"},We=Ne({__name:"Rules",setup(Oe){const s=Me(),J=Be(),ee=o("bypass"),k=o(!1),S=o([]),D=o([]),H=o([]),T=o([]),C=o(!1),$=o(!1),z=o(!1),A=o(!1),I=o(!1),M=o(!1),B=o(null),N=o(null),U=o(null),u=o({name:"",whitelist:!1,node_id:null,matchersText:""}),d=o({name:"",whitelist:!1,node_id:null,matchersText:""}),f=o({name:"",node_id:null,mappingsText:""}),R=De(()=>T.value.map(t=>({label:`${t.name} (${t.host}:${t.port})`,value:t.id}))),te=t=>{const e=t.split(`
`).map(i=>i.trim()).filter(i=>i&&!i.startsWith("#"));return JSON.stringify(e)},ae=t=>{try{const e=JSON.parse(t);return Array.isArray(e)?e.join(`
`):""}catch{return""}},ne=t=>{const e=[],i=t.split(`
`).map(y=>y.trim()).filter(y=>y&&!y.startsWith("#"));for(const y of i){const h=y.split(/\s+/);if(h.length>=2){const O={ip:h[0],hostname:h[1]};h[2]&&(O.prefer=h[2]),e.push(O)}}return JSON.stringify(e)},se=t=>{try{const e=JSON.parse(t);return Array.isArray(e)?e.map(i=>{let y=`${i.ip} ${i.hostname}`;return i.prefer&&(y+=` ${i.prefer}`),y}).join(`
`):""}catch{return""}},L=t=>{try{return JSON.parse(t)?.length||0}catch{return 0}},ie=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"模式",key:"whitelist",width:100,render:t=>v(P,{type:t.whitelist?"success":"warning",size:"small"},()=>t.whitelist?"白名单":"黑名单")},{title:"规则数",key:"matchers",width:80,render:t=>L(t.matchers)},{title:"关联节点",key:"node_id",width:120,render:t=>{if(!t.node_id)return v(P,{size:"small"},()=>"全局");const e=T.value.find(i=>i.id===t.node_id);return e?e.name:`#${t.node_id}`}},{title:"操作",key:"actions",width:150,render:t=>v(_,{size:"small"},()=>[v(p,{size:"small",onClick:()=>q(t)},()=>"编辑"),v(p,{size:"small",type:"error",onClick:()=>ue(t)},()=>"删除")])}],V=async()=>{C.value=!0;try{const t=await ge();S.value=t||[]}catch{s.error("加载分流规则失败")}finally{C.value=!1}},q=t=>{t?(B.value=t,u.value={name:t.name,whitelist:t.whitelist,node_id:t.node_id||null,matchersText:ae(t.matchers)}):(B.value=null,u.value={name:"",whitelist:!1,node_id:null,matchersText:""}),A.value=!0},oe=async()=>{if(!u.value.name){s.error("请输入名称");return}k.value=!0;try{const t={name:u.value.name,whitelist:u.value.whitelist,node_id:u.value.node_id||void 0,matchers:te(u.value.matchersText)};B.value?(await _e(B.value.id,t),s.success("规则已更新")):(await be(t),s.success("规则已创建")),A.value=!1,V()}catch(t){s.error(t.response?.data?.error||"保存失败")}finally{k.value=!1}},ue=t=>{J.warning({title:"删除分流规则",content:`确定要删除 "${t.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await ze(t.id),s.success("已删除"),V()}catch{s.error("删除失败")}}})},de=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"模式",key:"whitelist",width:100,render:t=>v(P,{type:t.whitelist?"success":"warning",size:"small"},()=>t.whitelist?"白名单":"黑名单")},{title:"规则数",key:"matchers",width:80,render:t=>L(t.matchers)},{title:"关联节点",key:"node_id",width:120,render:t=>{if(!t.node_id)return v(P,{size:"small"},()=>"全局");const e=T.value.find(i=>i.id===t.node_id);return e?e.name:`#${t.node_id}`}},{title:"操作",key:"actions",width:150,render:t=>v(_,{size:"small"},()=>[v(p,{size:"small",onClick:()=>F(t)},()=>"编辑"),v(p,{size:"small",type:"error",onClick:()=>pe(t)},()=>"删除")])}],E=async()=>{$.value=!0;try{const t=await we();D.value=t||[]}catch{s.error("加载准入规则失败")}finally{$.value=!1}},F=t=>{t?(N.value=t,d.value={name:t.name,whitelist:t.whitelist,node_id:t.node_id||null,matchersText:ae(t.matchers)}):(N.value=null,d.value={name:"",whitelist:!1,node_id:null,matchersText:""}),I.value=!0},re=async()=>{if(!d.value.name){s.error("请输入名称");return}k.value=!0;try{const t={name:d.value.name,whitelist:d.value.whitelist,node_id:d.value.node_id||void 0,matchers:te(d.value.matchersText)};N.value?(await xe(N.value.id,t),s.success("规则已更新")):(await Te(t),s.success("规则已创建")),I.value=!1,E()}catch(t){s.error(t.response?.data?.error||"保存失败")}finally{k.value=!1}},pe=t=>{J.warning({title:"删除准入规则",content:`确定要删除 "${t.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Ae(t.id),s.success("已删除"),E()}catch{s.error("删除失败")}}})},me=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"映射数",key:"mappings",width:80,render:t=>L(t.mappings)},{title:"关联节点",key:"node_id",width:120,render:t=>{if(!t.node_id)return v(P,{size:"small"},()=>"全局");const e=T.value.find(i=>i.id===t.node_id);return e?e.name:`#${t.node_id}`}},{title:"操作",key:"actions",width:150,render:t=>v(_,{size:"small"},()=>[v(p,{size:"small",onClick:()=>K(t)},()=>"编辑"),v(p,{size:"small",type:"error",onClick:()=>fe(t)},()=>"删除")])}],W=async()=>{z.value=!0;try{const t=await ke();H.value=t||[]}catch{s.error("加载主机映射失败")}finally{z.value=!1}},K=t=>{t?(U.value=t,f.value={name:t.name,node_id:t.node_id||null,mappingsText:se(t.mappings)}):(U.value=null,f.value={name:"",node_id:null,mappingsText:""}),M.value=!0},ve=async()=>{if(!f.value.name){s.error("请输入名称");return}k.value=!0;try{const t={name:f.value.name,node_id:f.value.node_id||void 0,mappings:ne(f.value.mappingsText)};U.value?(await Ce(U.value.id,t),s.success("映射已更新")):(await $e(t),s.success("映射已创建")),M.value=!1,W()}catch(t){s.error(t.response?.data?.error||"保存失败")}finally{k.value=!1}},fe=t=>{J.warning({title:"删除主机映射",content:`确定要删除 "${t.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Ie(t.id),s.success("已删除"),W()}catch{s.error("删除失败")}}})},ye=async()=>{try{const t=await he();T.value=t||[]}catch{}};return Ue(()=>{ye(),V(),E(),W()}),(t,e)=>{const i=c("n-alert"),y=c("n-data-table"),h=c("n-tab-pane"),O=c("n-tabs"),ce=c("n-card"),x=c("n-input"),g=c("n-form-item"),j=c("n-radio"),le=c("n-radio-group"),Q=c("n-select"),X=c("n-form"),Y=c("n-modal");return w(),Pe("div",He,[a(ce,null,{header:l(()=>[...e[24]||(e[24]=[Se("span",null,"规则管理",-1)])]),default:l(()=>[a(O,{type:"line",value:ee.value,"onUpdate:value":e[6]||(e[6]=n=>ee.value=n)},{default:l(()=>[a(h,{name:"bypass",tab:"分流规则 (Bypass)"},{default:l(()=>[a(i,{type:"info",style:{"margin-bottom":"16px"}},{default:l(()=>[...e[25]||(e[25]=[r(" 分流规则控制哪些目标地址走代理或直连。黑名单模式：匹配的地址不走代理；白名单模式：仅匹配的地址走代理。 ",-1)])]),_:1}),a(m(_),{justify:"end",style:{"margin-bottom":"12px"}},{default:l(()=>[a(m(p),{type:"primary",size:"small",onClick:e[0]||(e[0]=n=>q())},{default:l(()=>[...e[26]||(e[26]=[r("添加规则",-1)])]),_:1})]),_:1}),C.value&&S.value.length===0?(w(),b(G,{key:0,rows:3})):!C.value&&S.value.length===0?(w(),b(Z,{key:1,type:"rules","action-text":"添加规则",onAction:e[1]||(e[1]=n=>q())})):(w(),b(y,{key:2,columns:ie,data:S.value,loading:C.value,"row-key":n=>n.id,size:"small"},null,8,["data","loading","row-key"]))]),_:1}),a(h,{name:"admission",tab:"准入控制 (Admission)"},{default:l(()=>[a(i,{type:"info",style:{"margin-bottom":"16px"}},{default:l(()=>[...e[27]||(e[27]=[r(" 准入控制限制哪些客户端 IP 可以连接代理服务。黑名单模式：拒绝匹配的 IP；白名单模式：仅允许匹配的 IP。 ",-1)])]),_:1}),a(m(_),{justify:"end",style:{"margin-bottom":"12px"}},{default:l(()=>[a(m(p),{type:"primary",size:"small",onClick:e[2]||(e[2]=n=>F())},{default:l(()=>[...e[28]||(e[28]=[r("添加规则",-1)])]),_:1})]),_:1}),$.value&&D.value.length===0?(w(),b(G,{key:0,rows:3})):!$.value&&D.value.length===0?(w(),b(Z,{key:1,type:"rules","action-text":"添加规则",onAction:e[3]||(e[3]=n=>F())})):(w(),b(y,{key:2,columns:de,data:D.value,loading:$.value,"row-key":n=>n.id,size:"small"},null,8,["data","loading","row-key"]))]),_:1}),a(h,{name:"hosts",tab:"主机映射 (Hosts)"},{default:l(()=>[a(i,{type:"info",style:{"margin-bottom":"16px"}},{default:l(()=>[...e[29]||(e[29]=[r(" 自定义 DNS 解析，将域名映射到指定 IP 地址，类似 /etc/hosts 文件。 ",-1)])]),_:1}),a(m(_),{justify:"end",style:{"margin-bottom":"12px"}},{default:l(()=>[a(m(p),{type:"primary",size:"small",onClick:e[4]||(e[4]=n=>K())},{default:l(()=>[...e[30]||(e[30]=[r("添加映射",-1)])]),_:1})]),_:1}),z.value&&H.value.length===0?(w(),b(G,{key:0,rows:3})):!z.value&&H.value.length===0?(w(),b(Z,{key:1,type:"rules","action-text":"添加映射",onAction:e[5]||(e[5]=n=>K())})):(w(),b(y,{key:2,columns:me,data:H.value,loading:z.value,"row-key":n=>n.id,size:"small"},null,8,["data","loading","row-key"]))]),_:1})]),_:1},8,["value"])]),_:1}),a(Y,{show:A.value,"onUpdate:show":e[12]||(e[12]=n=>A.value=n),preset:"dialog",title:B.value?"编辑分流规则":"添加分流规则",style:{width:"600px"}},{action:l(()=>[a(m(_),null,{default:l(()=>[a(m(p),{onClick:e[11]||(e[11]=n=>A.value=!1)},{default:l(()=>[...e[33]||(e[33]=[r("取消",-1)])]),_:1}),a(m(p),{type:"primary",loading:k.value,onClick:oe},{default:l(()=>[...e[34]||(e[34]=[r("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[a(X,{model:u.value,"label-placement":"left","label-width":"100"},{default:l(()=>[a(g,{label:"名称",required:""},{default:l(()=>[a(x,{value:u.value.name,"onUpdate:value":e[7]||(e[7]=n=>u.value.name=n),placeholder:"例如: 国内直连"},null,8,["value"])]),_:1}),a(g,{label:"模式"},{default:l(()=>[a(le,{value:u.value.whitelist,"onUpdate:value":e[8]||(e[8]=n=>u.value.whitelist=n)},{default:l(()=>[a(j,{value:!1},{default:l(()=>[...e[31]||(e[31]=[r("黑名单 (匹配的不走代理)",-1)])]),_:1}),a(j,{value:!0},{default:l(()=>[...e[32]||(e[32]=[r("白名单 (仅匹配的走代理)",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),a(g,{label:"关联节点"},{default:l(()=>[a(Q,{value:u.value.node_id,"onUpdate:value":e[9]||(e[9]=n=>u.value.node_id=n),options:R.value,clearable:"",filterable:"",placeholder:"全局 (不关联节点)"},null,8,["value","options"])]),_:1}),a(g,{label:"规则列表"},{default:l(()=>[a(x,{value:u.value.matchersText,"onUpdate:value":e[10]||(e[10]=n=>u.value.matchersText=n),type:"textarea",rows:8,placeholder:`每行一条规则，支持：
*.google.com (域名通配)
.github.com (子域名匹配)
10.0.0.0/8 (IP/CIDR)
192.168.1.1 (精确 IP)`},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(Y,{show:I.value,"onUpdate:show":e[18]||(e[18]=n=>I.value=n),preset:"dialog",title:N.value?"编辑准入规则":"添加准入规则",style:{width:"600px"}},{action:l(()=>[a(m(_),null,{default:l(()=>[a(m(p),{onClick:e[17]||(e[17]=n=>I.value=!1)},{default:l(()=>[...e[37]||(e[37]=[r("取消",-1)])]),_:1}),a(m(p),{type:"primary",loading:k.value,onClick:re},{default:l(()=>[...e[38]||(e[38]=[r("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[a(X,{model:d.value,"label-placement":"left","label-width":"100"},{default:l(()=>[a(g,{label:"名称",required:""},{default:l(()=>[a(x,{value:d.value.name,"onUpdate:value":e[13]||(e[13]=n=>d.value.name=n),placeholder:"例如: 仅允许内网"},null,8,["value"])]),_:1}),a(g,{label:"模式"},{default:l(()=>[a(le,{value:d.value.whitelist,"onUpdate:value":e[14]||(e[14]=n=>d.value.whitelist=n)},{default:l(()=>[a(j,{value:!1},{default:l(()=>[...e[35]||(e[35]=[r("黑名单 (拒绝匹配的 IP)",-1)])]),_:1}),a(j,{value:!0},{default:l(()=>[...e[36]||(e[36]=[r("白名单 (仅允许匹配的 IP)",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),a(g,{label:"关联节点"},{default:l(()=>[a(Q,{value:d.value.node_id,"onUpdate:value":e[15]||(e[15]=n=>d.value.node_id=n),options:R.value,clearable:"",filterable:"",placeholder:"全局 (不关联节点)"},null,8,["value","options"])]),_:1}),a(g,{label:"IP 列表"},{default:l(()=>[a(x,{value:d.value.matchersText,"onUpdate:value":e[16]||(e[16]=n=>d.value.matchersText=n),type:"textarea",rows:8,placeholder:`每行一条规则，支持：
192.168.0.0/16 (CIDR)
10.0.0.1 (精确 IP)
172.16.0.0/12 (CIDR)`},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(Y,{show:M.value,"onUpdate:show":e[23]||(e[23]=n=>M.value=n),preset:"dialog",title:U.value?"编辑主机映射":"添加主机映射",style:{width:"650px"}},{action:l(()=>[a(m(_),null,{default:l(()=>[a(m(p),{onClick:e[22]||(e[22]=n=>M.value=!1)},{default:l(()=>[...e[39]||(e[39]=[r("取消",-1)])]),_:1}),a(m(p),{type:"primary",loading:k.value,onClick:ve},{default:l(()=>[...e[40]||(e[40]=[r("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[a(X,{model:f.value,"label-placement":"left","label-width":"100"},{default:l(()=>[a(g,{label:"名称",required:""},{default:l(()=>[a(x,{value:f.value.name,"onUpdate:value":e[19]||(e[19]=n=>f.value.name=n),placeholder:"例如: 自定义DNS"},null,8,["value"])]),_:1}),a(g,{label:"关联节点"},{default:l(()=>[a(Q,{value:f.value.node_id,"onUpdate:value":e[20]||(e[20]=n=>f.value.node_id=n),options:R.value,clearable:"",filterable:"",placeholder:"全局 (不关联节点)"},null,8,["value","options"])]),_:1}),a(g,{label:"映射规则"},{default:l(()=>[a(x,{value:f.value.mappingsText,"onUpdate:value":e[21]||(e[21]=n=>f.value.mappingsText=n),type:"textarea",rows:8,placeholder:`每行一条: IP 域名 [prefer]
例如:
127.0.0.1 example.com
1.2.3.4 api.example.com ipv4
::1 v6.example.com ipv6`},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}});export{We as default};
