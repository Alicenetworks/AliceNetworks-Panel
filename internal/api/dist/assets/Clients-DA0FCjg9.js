import{G as Me,i as Be,H as Pe,I as $e,J as Q,K as De,L as Ie,M as Oe,N as Re}from"./index-ZJAELyGg.js";import{E as ee,T as Ve}from"./TableSkeleton-CpNcW2pL.js";import{u as Le}from"./useKeyboard-CbOLAjL8.js";import{u as Fe,f as Ge,g as C,e as te,B as c,b as P,h as Ke,i as ae,p as Ee}from"./naive-ui-B4L8VU6X.js";import{k as Ae,o as We,Z as le,Y as a,W as l,r as s,V as d,X as y,U as N,N as i,a2 as je,j as r,a4 as ne,_ as oe,F as Je,m as q}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const He={class:"clients"},st=Ae({__name:"Clients",setup(Xe){const u=Fe(),W=Ge(),w=s(!1),$=s(!1),D=s(!1),S=s([]),se=s([]),g=s(!1),I=s(!1),x=s("linux"),T=s(!1),O=s(null),R=s(!1),z=s(""),M=s(""),V=s(""),U=s(null),b=s(""),L=s(null),v=s([]),f=s({page:1,pageSize:20,itemCount:0,showSizePicker:!0,pageSizes:[10,20,50,100]}),j=()=>({name:"",node_id:null,local_port:38777,remote_port:38777,proxy_user:"",proxy_pass:"",traffic_quota_gb:0,quota_reset_day:1}),o=s(j()),J=s([]),H=t=>{if(t===0)return"0 B";const e=1024,p=["B","KB","MB","GB","TB"],h=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,h)).toFixed(2))+" "+p[h]},ie=t=>!t||t.startsWith("0001")?"-":new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),ue=[{type:"selection",width:40},{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:120},{title:"节点",key:"node",width:120,render:t=>t.node?.name||"-"},{title:"端口",key:"ports",width:120,render:t=>`${t.local_port} → ${t.remote_port}`},{title:"状态",key:"status",width:80,render:t=>q(te,{type:t.status==="online"?"success":"default",size:"small"},()=>t.status==="online"?"在线":"离线")},{title:"流量",key:"traffic",width:120,render:t=>`↑${H(t.traffic_out)} ↓${H(t.traffic_in)}`},{title:"最后心跳",key:"last_seen",width:150,render:t=>ie(t.last_seen)},{title:"操作",key:"actions",width:200,render:t=>{const e=[{label:"安装脚本",key:"install"},{label:"复制 URI",key:"copy"},{label:"查看配置",key:"config"},{type:"divider",key:"d1"},{label:"删除",key:"delete"}],p=h=>{switch(h){case"install":me(t);break;case"copy":be(t);break;case"config":_e(t);break;case"delete":fe(t);break}};return q(C,{size:"small"},()=>[q(c,{size:"small",onClick:()=>ve(t)},()=>"编辑"),q(Ee,{options:e,onSelect:p,trigger:"click"},()=>q(c,{size:"small"},()=>"更多"))])}}],_=async()=>{w.value=!0;try{const t=await Me({page:f.value.page,page_size:f.value.pageSize,search:b.value});S.value=t.items||[],f.value.itemCount=t.total||0}catch{u.error("加载客户端失败")}finally{w.value=!1}},re=async()=>{try{const t=await Be();se.value=t,J.value=t.map(e=>({label:`${e.name} (${e.host}:${e.port})`,value:e.id}))}catch(t){console.error("Failed to load nodes",t)}},de=t=>{f.value.page=t,_()},pe=t=>{f.value.pageSize=t,f.value.page=1,_()},ce=()=>{L.value&&clearTimeout(L.value),L.value=setTimeout(()=>{f.value.page=1,_()},300)},F=()=>{o.value=j(),U.value=null,g.value=!0},ve=t=>{U.value=t,o.value={name:t.name,node_id:t.node_id,local_port:t.local_port,remote_port:t.remote_port,proxy_user:t.proxy_user||"",proxy_pass:t.proxy_pass||"",traffic_quota_gb:t.traffic_quota?t.traffic_quota/(1024*1024*1024):0,quota_reset_day:t.quota_reset_day||1},g.value=!0},X=async()=>{if(!o.value.name){u.warning("请输入名称");return}if(!o.value.node_id){u.warning("请选择节点");return}$.value=!0;try{const t={...o.value,traffic_quota:Math.round(o.value.traffic_quota_gb*1024*1024*1024)};delete t.traffic_quota_gb,U.value?(await Pe(U.value.id,t),u.success("客户端已更新")):(await $e(t),u.success("客户端已创建")),g.value=!1,_()}catch(t){u.error(t.response?.data?.error||"保存客户端失败")}finally{$.value=!1}},fe=t=>{W.warning({title:"删除客户端",content:`确定要删除客户端 "${t.name}" 吗？远程设备上的 Agent 将在下次心跳时自动卸载。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Ie(t.id),u.success("客户端已删除"),_()}catch{u.error("删除客户端失败")}}})},me=async t=>{try{O.value=t.id,x.value="linux";const e=await Q(t.id,"linux");z.value=e.script||"",M.value=e.one_line_command||"",I.value=!0}catch{u.error("获取安装脚本失败")}},ge=async t=>{if(O.value){T.value=!0;try{const e=await Q(O.value,t);z.value=e.script||"",M.value=e.one_line_command||""}catch{u.error("获取安装脚本失败")}finally{T.value=!1}}},_e=async t=>{try{const e=await Oe(t.id);V.value=typeof e=="string"?e:JSON.stringify(e,null,2),R.value=!0}catch{u.error("获取配置失败")}},ye=()=>{navigator.clipboard.writeText(M.value),u.success("已复制到剪贴板")},we=()=>{navigator.clipboard.writeText(z.value),u.success("已复制到剪贴板")},xe=()=>{navigator.clipboard.writeText(V.value),u.success("已复制到剪贴板")},be=async t=>{try{const e=await Re(t.id);navigator.clipboard.writeText(e.uri||""),u.success("代理 URI 已复制到剪贴板")}catch{u.error("获取代理 URI 失败")}},he=()=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let e="";for(let p=0;p<16;p++)e+=t.charAt(Math.floor(Math.random()*t.length));o.value.proxy_pass=e},ke=t=>{v.value=t},Ce=()=>{v.value.length!==0&&W.warning({title:"批量删除确认",content:`确定要删除选中的 ${v.value.length} 个客户端吗？此操作不可恢复！`,positiveText:"确定删除",negativeText:"取消",onPositiveClick:async()=>{D.value=!0;try{const t=await De(v.value);u.success(t.message||`成功删除 ${t.success} 个客户端`),v.value=[],await _()}catch(t){u.error(t.response?.data?.error||"批量删除失败")}finally{D.value=!1}}})};return We(()=>{_(),re()}),Le({onNew:F,modalVisible:g,onSave:X}),(t,e)=>{const p=d("n-input"),h=d("n-data-table"),Y=d("n-card"),m=d("n-form-item"),Se=d("n-select"),B=d("n-input-number"),k=d("n-grid-item"),G=d("n-grid"),Te=d("n-input-group"),Ue=d("n-form"),K=d("n-modal"),Z=d("n-alert"),E=d("n-code"),A=d("n-scrollbar"),Ne=d("n-collapse-item"),qe=d("n-collapse"),ze=d("n-spin");return y(),le("div",He,[a(Y,null,{header:l(()=>[a(i(C),{justify:"space-between",align:"center"},{default:l(()=>[a(i(C),{align:"center"},{default:l(()=>[e[14]||(e[14]=je("span",null,"客户端管理（内网穿透）",-1)),v.value.length>0?(y(),N(i(te),{key:0,type:"info",size:"small"},{default:l(()=>[r(" 已选 "+ne(v.value.length)+" 项 ",1)]),_:1})):oe("",!0)]),_:1}),a(i(C),null,{default:l(()=>[v.value.length>0?(y(),le(Je,{key:0},[a(i(c),{type:"error",onClick:Ce,loading:D.value},{default:l(()=>[...e[15]||(e[15]=[r(" 批量删除 ",-1)])]),_:1},8,["loading"]),a(i(P),{vertical:""})],64)):oe("",!0),a(p,{value:b.value,"onUpdate:value":[e[0]||(e[0]=n=>b.value=n),ce],placeholder:"搜索...",clearable:"",style:{width:"200px"}},null,8,["value"]),a(i(c),{type:"primary",onClick:F},{default:l(()=>[...e[16]||(e[16]=[r(" 添加客户端 ",-1)])]),_:1})]),_:1})]),_:1})]),default:l(()=>[w.value&&S.value.length===0?(y(),N(Ve,{key:0,rows:5})):!w.value&&S.value.length===0&&!b.value?(y(),N(ee,{key:1,type:"clients","action-text":"添加客户端",onAction:F})):!w.value&&S.value.length===0&&b.value?(y(),N(ee,{key:2,type:"search",description:`未找到与 '${b.value}' 匹配的客户端`},null,8,["description"])):(y(),N(h,{key:3,columns:ue,data:S.value,loading:w.value,"row-key":n=>n.id,pagination:f.value,"checked-row-keys":v.value,"onUpdate:checkedRowKeys":ke,remote:"","onUpdate:page":de,"onUpdate:pageSize":pe},null,8,["data","loading","row-key","pagination","checked-row-keys"]))]),_:1}),a(K,{show:g.value,"onUpdate:show":e[10]||(e[10]=n=>g.value=n),preset:"dialog",title:U.value?"编辑客户端":"添加客户端",style:{width:"650px","max-width":"90vw"}},{action:l(()=>[a(i(C),null,{default:l(()=>[a(i(c),{onClick:e[9]||(e[9]=n=>g.value=!1)},{default:l(()=>[...e[25]||(e[25]=[r("取消",-1)])]),_:1}),a(i(c),{type:"primary",loading:$.value,onClick:X},{default:l(()=>[...e[26]||(e[26]=[r("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:l(()=>[a(Ue,{model:o.value,"label-placement":"left","label-width":"100"},{default:l(()=>[a(m,{label:"名称",required:""},{default:l(()=>[a(p,{value:o.value.name,"onUpdate:value":e[1]||(e[1]=n=>o.value.name=n),placeholder:"例如: 家里电脑、公司内网"},null,8,["value"])]),_:1}),a(m,{label:"绑定节点",required:""},{default:l(()=>[a(Se,{value:o.value.node_id,"onUpdate:value":e[2]||(e[2]=n=>o.value.node_id=n),options:J.value,placeholder:"选择入口节点（VPS）",filterable:""},null,8,["value","options"])]),_:1}),a(i(P),null,{default:l(()=>[...e[17]||(e[17]=[r("端口配置",-1)])]),_:1}),a(G,{cols:2,"x-gap":12},{default:l(()=>[a(k,null,{default:l(()=>[a(m,{label:"本地端口"},{default:l(()=>[a(B,{value:o.value.local_port,"onUpdate:value":e[3]||(e[3]=n=>o.value.local_port=n),min:1,max:65535,style:{width:"100%"}},{suffix:l(()=>[...e[18]||(e[18]=[r("内网",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),a(k,null,{default:l(()=>[a(m,{label:"远程端口"},{default:l(()=>[a(B,{value:o.value.remote_port,"onUpdate:value":e[4]||(e[4]=n=>o.value.remote_port=n),min:1,max:65535,style:{width:"100%"}},{suffix:l(()=>[...e[19]||(e[19]=[r("VPS",-1)])]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),a(i(P),null,{default:l(()=>[...e[20]||(e[20]=[r("代理认证（可选）",-1)])]),_:1}),a(G,{cols:2,"x-gap":12},{default:l(()=>[a(k,null,{default:l(()=>[a(m,{label:"用户名"},{default:l(()=>[a(p,{value:o.value.proxy_user,"onUpdate:value":e[5]||(e[5]=n=>o.value.proxy_user=n),placeholder:"代理用户名"},null,8,["value"])]),_:1})]),_:1}),a(k,null,{default:l(()=>[a(m,{label:"密码"},{default:l(()=>[a(Te,null,{default:l(()=>[a(p,{value:o.value.proxy_pass,"onUpdate:value":e[6]||(e[6]=n=>o.value.proxy_pass=n),placeholder:"代理密码"},null,8,["value"]),a(i(c),{onClick:he},{default:l(()=>[...e[21]||(e[21]=[r("生成",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(i(P),null,{default:l(()=>[...e[22]||(e[22]=[r("流量配额（可选）",-1)])]),_:1}),a(G,{cols:2,"x-gap":12},{default:l(()=>[a(k,null,{default:l(()=>[a(m,{label:"配额"},{default:l(()=>[a(B,{value:o.value.traffic_quota_gb,"onUpdate:value":e[7]||(e[7]=n=>o.value.traffic_quota_gb=n),min:0,precision:2,style:{width:"100%"}},{suffix:l(()=>[...e[23]||(e[23]=[r("GB",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),a(k,null,{default:l(()=>[a(m,{label:"重置日"},{default:l(()=>[a(B,{value:o.value.quota_reset_day,"onUpdate:value":e[8]||(e[8]=n=>o.value.quota_reset_day=n),min:1,max:28,style:{width:"100%"}},{suffix:l(()=>[...e[24]||(e[24]=[r("日",-1)])]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(K,{show:I.value,"onUpdate:show":e[12]||(e[12]=n=>I.value=n),preset:"dialog",title:"安装脚本",style:{width:"750px","max-width":"90vw"}},{action:l(()=>[a(i(C),null,{default:l(()=>[a(i(c),{onClick:ye,disabled:T.value},{default:l(()=>[...e[27]||(e[27]=[r("复制一键命令",-1)])]),_:1},8,["disabled"]),a(i(c),{onClick:we,disabled:T.value},{default:l(()=>[...e[28]||(e[28]=[r("复制完整脚本",-1)])]),_:1},8,["disabled"])]),_:1})]),default:l(()=>[a(i(Ke),{value:x.value,"onUpdate:value":[e[11]||(e[11]=n=>x.value=n),ge],type:"segment",style:{"margin-bottom":"16px"}},{default:l(()=>[a(i(ae),{name:"linux",tab:"Linux / macOS"}),a(i(ae),{name:"windows",tab:"Windows"})]),_:1},8,["value"]),a(ze,{show:T.value},{default:l(()=>[a(Z,{type:"info",style:{"margin-bottom":"16px"}},{default:l(()=>[r(ne(x.value==="linux"?"在内网设备上运行以下命令：":"在 PowerShell (管理员) 中运行："),1)]),_:1}),a(Y,{size:"small",style:{"margin-bottom":"16px"}},{default:l(()=>[a(A,{"x-scrollable":""},{default:l(()=>[a(E,{code:M.value,language:x.value==="linux"?"bash":"powershell","word-wrap":""},null,8,["code","language"])]),_:1})]),_:1}),a(qe,null,{default:l(()=>[a(Ne,{title:"查看完整脚本",name:"details"},{default:l(()=>[a(A,{"x-scrollable":"",style:{"max-height":"300px"}},{default:l(()=>[a(E,{code:z.value,language:x.value==="linux"?"bash":"powershell","word-wrap":""},null,8,["code","language"])]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])]),_:1},8,["show"]),a(K,{show:R.value,"onUpdate:show":e[13]||(e[13]=n=>R.value=n),preset:"dialog",title:"GOST 配置",style:{width:"700px","max-width":"90vw"}},{action:l(()=>[a(i(c),{onClick:xe},{default:l(()=>[...e[30]||(e[30]=[r("复制配置",-1)])]),_:1})]),default:l(()=>[a(Z,{type:"info",style:{"margin-bottom":"16px"}},{default:l(()=>[...e[29]||(e[29]=[r(" 这是客户端的 GOST 配置文件内容，保存到 /etc/gost/gost.yml ",-1)])]),_:1}),a(A,{"x-scrollable":"",style:{"max-height":"400px"}},{default:l(()=>[a(E,{code:V.value,language:"yaml","word-wrap":""},null,8,["code"])]),_:1})]),_:1},8,["show"])])}}});export{st as default};
