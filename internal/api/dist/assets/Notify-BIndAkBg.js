import{Z as Ae,_ as ze,$ as Se,a0 as Ne,a1 as Re,a2 as De,a3 as Me,a4 as Pe,a5 as Be,a6 as Le}from"./index-ZJAELyGg.js";import{T as re,E as de}from"./TableSkeleton-CpNcW2pL.js";import{u as Ee,f as $e,g as w,B as g,e as S}from"./naive-ui-B4L8VU6X.js";import{k as Fe,o as Ie,E as Oe,Z as $,Y as a,W as n,r as d,V as m,X as v,U as k,N as p,a2 as P,j as b,F as H,_ as x,c as ve,m as y}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ve={class:"notify"},Ke=Fe({__name:"Notify",setup(je){const i=Ee(),Z=$e();let f=!1;const N=d(!1),R=d(!1),F=d(!1),T=d(!1),I=d(!1),U=d([]),B=d([]),X=d([]),A=d(!1),z=d(!1),C=d(null),D=d(null),Y=[{label:"Telegram",value:"telegram"},{label:"Webhook",value:"webhook"},{label:"Email (SMTP)",value:"email"}],J=[{label:"节点离线",value:"node_offline"},{label:"节点恢复在线",value:"node_online"},{label:"流量超限",value:"quota_exceeded"},{label:"流量预警",value:"quota_warning"},{label:"连接数告警",value:"connection_limit"},{label:"Agent 更新",value:"agent_update"}],O=()=>({name:"",type:"telegram",config:{},enabled:!0}),V=()=>({name:"",alert_type:"node_offline",channel_ids:[],condition:{},silence_duration:3e5,enabled:!0}),r=d(O()),s=d(V()),u=d({}),h=d({}),K=ve({get:()=>s.value.silence_duration/6e4,set:l=>{s.value.silence_duration=l*6e4}}),pe=ve(()=>Array.isArray(U.value)?U.value.filter(l=>l&&l.enabled).map(l=>({label:`${l.name} (${Q(l.type)})`,value:l.id})):[]),fe=d({page:1,pageSize:20}),Q=l=>{const e=Y.find(_=>_.value===l);return e?e.label:l},ee=l=>{const e=J.find(_=>_.value===l);return e?e.label:l},le=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-",me=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"类型",key:"type",width:120,render:l=>y(S,{type:"info",size:"small"},()=>Q(l.type))},{title:"状态",key:"enabled",width:80,render:l=>y(S,{type:l.enabled?"success":"default",size:"small"},()=>l.enabled?"启用":"禁用")},{title:"最后测试",key:"last_test_at",width:150,render:l=>le(l.last_test_at)},{title:"操作",key:"actions",width:220,render:l=>y(w,{size:"small"},()=>[y(g,{size:"small",onClick:()=>ce(l)},()=>"编辑"),y(g,{size:"small",type:"info",onClick:()=>te(l)},()=>"测试"),y(g,{size:"small",type:"error",onClick:()=>he(l)},()=>"删除")])}],ye=[{title:"ID",key:"id",width:60},{title:"规则名称",key:"name",width:180},{title:"告警类型",key:"alert_type",width:150,render:l=>y(S,{type:"warning",size:"small"},()=>ee(l.alert_type))},{title:"通知渠道",key:"channel_count",width:100,render:l=>`${l.channel_ids?.length||0} 个`},{title:"状态",key:"enabled",width:80,render:l=>y(S,{type:l.enabled?"success":"default",size:"small"},()=>l.enabled?"启用":"禁用")},{title:"触发次数",key:"trigger_count",width:100},{title:"操作",key:"actions",width:150,render:l=>y(w,{size:"small"},()=>[y(g,{size:"small",onClick:()=>Ce(l)},()=>"编辑"),y(g,{size:"small",type:"error",onClick:()=>Te(l)},()=>"删除")])}],ge=[{title:"ID",key:"id",width:60},{title:"告警类型",key:"alert_type",width:130,render:l=>y(S,{type:"warning",size:"small"},()=>ee(l.alert_type))},{title:"消息",key:"message",ellipsis:{tooltip:!0}},{title:"发送状态",key:"sent",width:100,render:l=>y(S,{type:l.sent?"success":"error",size:"small"},()=>l.sent?"已发送":"失败")},{title:"时间",key:"created_at",width:160,render:l=>le(l.created_at)}],L=async()=>{if(!f){N.value=!0;try{const l=await Ae();if(f)return;U.value=Array.isArray(l)?l:[]}catch{f||i.error("加载通知渠道失败")}finally{f||(N.value=!1)}}},j=async()=>{if(!f){R.value=!0;try{const l=await ze();if(f)return;const e=Array.isArray(l)?l:[];B.value=e.map(_=>({..._,channel_ids:Array.isArray(_.channel_ids)?_.channel_ids:[]}))}catch{f||i.error("加载告警规则失败")}finally{f||(R.value=!1)}}},_e=async()=>{if(!f){F.value=!0;try{const l=await Se({limit:100});if(f)return;X.value=Array.isArray(l)?l:[]}catch{f||i.error("加载告警日志失败")}finally{f||(F.value=!1)}}},ae=()=>{r.value=O(),u.value={},C.value=null,A.value=!0},ce=l=>{C.value=l,r.value={...O(),...l},u.value={...l.config},A.value=!0},be=()=>{u.value={},r.value.type==="telegram"?u.value={bot_token:"",chat_id:""}:r.value.type==="webhook"?u.value={url:"",method:"POST",headers:""}:r.value.type==="email"&&(u.value={smtp_host:"",smtp_port:587,username:"",password:"",from:"",to:"",use_tls:!0})},ke=async()=>{if(!r.value.name){i.error("请输入名称");return}r.value.config=u.value,T.value=!0;try{C.value?(await Ne(C.value.id,r.value),i.success("通知渠道已更新")):(await Re(r.value),i.success("通知渠道已创建")),A.value=!1,L()}catch(l){i.error(l.response?.data?.error||"保存通知渠道失败")}finally{T.value=!1}},he=l=>{Z.warning({title:"删除通知渠道",content:`确定要删除通知渠道 "${l.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Pe(l.id),i.success("通知渠道已删除"),L()}catch{i.error("删除通知渠道失败")}}})},te=async l=>{I.value=!0;try{await Be(l.id),i.success("测试通知已发送"),L()}catch(e){i.error(e.response?.data?.error||"发送测试通知失败")}finally{I.value=!1}},we=async()=>{if(!C.value){i.error("请先保存渠道后再测试");return}await te(C.value)},ne=()=>{s.value=V(),h.value={offline_duration:5},D.value=null,z.value=!0},Ce=l=>{D.value=l;const e=Array.isArray(l.channel_ids)?l.channel_ids:[];s.value={...V(),...l,channel_ids:e},h.value={...l.condition},z.value=!0},xe=async()=>{if(!s.value.name){i.error("请输入规则名称");return}if(!s.value.channel_ids||s.value.channel_ids.length===0){i.error("请选择至少一个通知渠道");return}s.value.condition=h.value,T.value=!0;try{D.value?(await De(D.value.id,s.value),i.success("告警规则已更新")):(await Me(s.value),i.success("告警规则已创建")),z.value=!1,j()}catch(l){i.error(l.response?.data?.error||"保存告警规则失败")}finally{T.value=!1}},Te=l=>{Z.warning({title:"删除告警规则",content:`确定要删除告警规则 "${l.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Le(l.id),i.success("告警规则已删除"),j()}catch{i.error("删除告警规则失败")}}})};return Ie(()=>{L(),j(),_e()}),Oe(()=>{f=!0}),(l,e)=>{const _=m("n-data-table"),q=m("n-card"),W=m("n-grid-item"),Ue=m("n-grid"),c=m("n-input"),o=m("n-form-item"),E=m("n-select"),M=m("n-input-number"),G=m("n-switch"),ue=m("n-form"),oe=m("n-modal"),se=m("n-divider"),ie=m("n-text");return v(),$("div",Ve,[a(Ue,{"x-gap":16,"y-gap":16,cols:1},{default:n(()=>[a(W,null,{default:n(()=>[a(q,null,{header:n(()=>[a(p(w),{justify:"space-between",align:"center"},{default:n(()=>[e[28]||(e[28]=P("span",null,"通知渠道",-1)),a(p(g),{type:"primary",onClick:ae},{default:n(()=>[...e[27]||(e[27]=[b(" 添加渠道 ",-1)])]),_:1})]),_:1})]),default:n(()=>[N.value&&U.value.length===0?(v(),k(re,{key:0,rows:2})):!N.value&&U.value.length===0?(v(),k(de,{key:1,type:"notify","action-text":"添加渠道",onAction:ae})):(v(),k(_,{key:2,columns:me,data:U.value,loading:N.value,"row-key":t=>t.id},null,8,["data","loading","row-key"]))]),_:1})]),_:1}),a(W,null,{default:n(()=>[a(q,null,{header:n(()=>[a(p(w),{justify:"space-between",align:"center"},{default:n(()=>[e[30]||(e[30]=P("span",null,"告警规则",-1)),a(p(g),{type:"primary",onClick:ne},{default:n(()=>[...e[29]||(e[29]=[b(" 添加规则 ",-1)])]),_:1})]),_:1})]),default:n(()=>[R.value&&B.value.length===0?(v(),k(re,{key:0,rows:2})):!R.value&&B.value.length===0?(v(),k(de,{key:1,title:"暂无告警规则",description:"创建告警规则来监控节点状态","action-text":"添加规则",onAction:ne})):(v(),k(_,{key:2,columns:ye,data:B.value,loading:R.value,"row-key":t=>t.id},null,8,["data","loading","row-key"]))]),_:1})]),_:1}),a(W,null,{default:n(()=>[a(q,{title:"告警日志"},{default:n(()=>[a(_,{columns:ge,data:X.value,loading:F.value,"row-key":t=>t.id,pagination:fe.value,size:"small","max-height":"400"},null,8,["data","loading","row-key","pagination"])]),_:1})]),_:1})]),_:1}),a(oe,{show:A.value,"onUpdate:show":e[16]||(e[16]=t=>A.value=t),preset:"dialog",title:C.value?"编辑通知渠道":"添加通知渠道",style:{width:"600px"}},{action:n(()=>[a(p(w),null,{default:n(()=>[a(p(g),{onClick:e[15]||(e[15]=t=>A.value=!1)},{default:n(()=>[...e[31]||(e[31]=[b("取消",-1)])]),_:1}),C.value?(v(),k(p(g),{key:0,type:"info",loading:I.value,onClick:we},{default:n(()=>[...e[32]||(e[32]=[b("测试",-1)])]),_:1},8,["loading"])):x("",!0),a(p(g),{type:"primary",loading:T.value,onClick:ke},{default:n(()=>[...e[33]||(e[33]=[b("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:n(()=>[a(ue,{model:r.value,"label-placement":"left","label-width":"100"},{default:n(()=>[a(o,{label:"名称"},{default:n(()=>[a(c,{value:r.value.name,"onUpdate:value":e[0]||(e[0]=t=>r.value.name=t),placeholder:"例如: Telegram Bot"},null,8,["value"])]),_:1}),a(o,{label:"类型"},{default:n(()=>[a(E,{value:r.value.type,"onUpdate:value":[e[1]||(e[1]=t=>r.value.type=t),be],options:Y},null,8,["value"])]),_:1}),r.value.type==="telegram"?(v(),$(H,{key:0},[a(o,{label:"Bot Token"},{default:n(()=>[a(c,{value:u.value.bot_token,"onUpdate:value":e[2]||(e[2]=t=>u.value.bot_token=t),placeholder:"从 @BotFather 获取"},null,8,["value"])]),_:1}),a(o,{label:"Chat ID"},{default:n(()=>[a(c,{value:u.value.chat_id,"onUpdate:value":e[3]||(e[3]=t=>u.value.chat_id=t),placeholder:"你的 Chat ID"},null,8,["value"])]),_:1})],64)):x("",!0),r.value.type==="webhook"?(v(),$(H,{key:1},[a(o,{label:"Webhook URL"},{default:n(()=>[a(c,{value:u.value.url,"onUpdate:value":e[4]||(e[4]=t=>u.value.url=t),placeholder:"https://your-webhook-url"},null,8,["value"])]),_:1}),a(o,{label:"HTTP 方法"},{default:n(()=>[a(E,{value:u.value.method,"onUpdate:value":e[5]||(e[5]=t=>u.value.method=t),options:[{label:"POST",value:"POST"},{label:"GET",value:"GET"}]},null,8,["value"])]),_:1}),a(o,{label:"Headers"},{default:n(()=>[a(c,{value:u.value.headers,"onUpdate:value":e[6]||(e[6]=t=>u.value.headers=t),type:"textarea",placeholder:'{"Content-Type": "application/json"}',autosize:{minRows:2}},null,8,["value"])]),_:1})],64)):x("",!0),r.value.type==="email"?(v(),$(H,{key:2},[a(o,{label:"SMTP 服务器"},{default:n(()=>[a(c,{value:u.value.smtp_host,"onUpdate:value":e[7]||(e[7]=t=>u.value.smtp_host=t),placeholder:"smtp.gmail.com"},null,8,["value"])]),_:1}),a(o,{label:"SMTP 端口"},{default:n(()=>[a(M,{value:u.value.smtp_port,"onUpdate:value":e[8]||(e[8]=t=>u.value.smtp_port=t),min:1,max:65535,style:{width:"150px"}},null,8,["value"])]),_:1}),a(o,{label:"用户名"},{default:n(()=>[a(c,{value:u.value.username,"onUpdate:value":e[9]||(e[9]=t=>u.value.username=t),placeholder:"your@email.com"},null,8,["value"])]),_:1}),a(o,{label:"密码"},{default:n(()=>[a(c,{value:u.value.password,"onUpdate:value":e[10]||(e[10]=t=>u.value.password=t),type:"password",placeholder:"SMTP 密码"},null,8,["value"])]),_:1}),a(o,{label:"发件人"},{default:n(()=>[a(c,{value:u.value.from,"onUpdate:value":e[11]||(e[11]=t=>u.value.from=t),placeholder:"noreply@example.com"},null,8,["value"])]),_:1}),a(o,{label:"收件人"},{default:n(()=>[a(c,{value:u.value.to,"onUpdate:value":e[12]||(e[12]=t=>u.value.to=t),placeholder:"admin@example.com (多个用逗号分隔)"},null,8,["value"])]),_:1}),a(o,{label:"使用 TLS"},{default:n(()=>[a(G,{value:u.value.use_tls,"onUpdate:value":e[13]||(e[13]=t=>u.value.use_tls=t)},null,8,["value"])]),_:1})],64)):x("",!0),a(o,{label:"启用"},{default:n(()=>[a(G,{value:r.value.enabled,"onUpdate:value":e[14]||(e[14]=t=>r.value.enabled=t)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(oe,{show:z.value,"onUpdate:show":e[26]||(e[26]=t=>z.value=t),preset:"dialog",title:D.value?"编辑告警规则":"添加告警规则",style:{width:"600px"}},{action:n(()=>[a(p(w),null,{default:n(()=>[a(p(g),{onClick:e[25]||(e[25]=t=>z.value=!1)},{default:n(()=>[...e[41]||(e[41]=[b("取消",-1)])]),_:1}),a(p(g),{type:"primary",loading:T.value,onClick:xe},{default:n(()=>[...e[42]||(e[42]=[b("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:n(()=>[a(ue,{model:s.value,"label-placement":"left","label-width":"120"},{default:n(()=>[a(o,{label:"规则名称"},{default:n(()=>[a(c,{value:s.value.name,"onUpdate:value":e[17]||(e[17]=t=>s.value.name=t),placeholder:"例如: 节点离线告警"},null,8,["value"])]),_:1}),a(o,{label:"告警类型"},{default:n(()=>[a(E,{value:s.value.alert_type,"onUpdate:value":e[18]||(e[18]=t=>s.value.alert_type=t),options:J},null,8,["value"])]),_:1}),a(o,{label:"通知渠道"},{default:n(()=>[a(E,{value:s.value.channel_ids,"onUpdate:value":e[19]||(e[19]=t=>s.value.channel_ids=t),options:pe.value,multiple:"",placeholder:"选择一个或多个渠道"},null,8,["value","options"])]),_:1}),a(se,null,{default:n(()=>[...e[34]||(e[34]=[b("触发条件",-1)])]),_:1}),s.value.alert_type==="node_offline"?(v(),k(o,{key:0,label:"离线时长"},{default:n(()=>[a(p(w),null,{default:n(()=>[a(M,{value:h.value.offline_duration,"onUpdate:value":e[20]||(e[20]=t=>h.value.offline_duration=t),min:1,style:{width:"120px"}},null,8,["value"]),e[35]||(e[35]=P("span",null,"分钟",-1))]),_:1})]),_:1})):x("",!0),s.value.alert_type==="quota_warning"?(v(),k(o,{key:1,label:"流量使用率"},{default:n(()=>[a(p(w),null,{default:n(()=>[a(M,{value:h.value.threshold,"onUpdate:value":e[21]||(e[21]=t=>h.value.threshold=t),min:1,max:100,style:{width:"120px"}},null,8,["value"]),e[36]||(e[36]=P("span",null,"%",-1))]),_:1}),a(ie,{depth:"3",style:{"margin-top":"4px","font-size":"12px"}},{default:n(()=>[...e[37]||(e[37]=[b("当流量使用达到此百分比时发送预警",-1)])]),_:1})]),_:1})):x("",!0),s.value.alert_type==="connection_limit"?(v(),k(o,{key:2,label:"连接数阈值"},{default:n(()=>[a(M,{value:h.value.max_connections,"onUpdate:value":e[22]||(e[22]=t=>h.value.max_connections=t),min:1,style:{width:"150px"}},null,8,["value"])]),_:1})):x("",!0),a(se,null,{default:n(()=>[...e[38]||(e[38]=[b("其他选项",-1)])]),_:1}),a(o,{label:"静默时间"},{default:n(()=>[a(p(w),null,{default:n(()=>[a(M,{value:K.value,"onUpdate:value":e[23]||(e[23]=t=>K.value=t),min:1,style:{width:"120px"}},null,8,["value"]),e[39]||(e[39]=P("span",null,"分钟",-1))]),_:1}),a(ie,{depth:"3",style:{"margin-top":"4px","font-size":"12px"}},{default:n(()=>[...e[40]||(e[40]=[b("同一告警在静默时间内不会重复发送",-1)])]),_:1})]),_:1}),a(o,{label:"启用"},{default:n(()=>[a(G,{value:s.value.enabled,"onUpdate:value":e[24]||(e[24]=t=>s.value.enabled=t)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}});export{Ke as default};
