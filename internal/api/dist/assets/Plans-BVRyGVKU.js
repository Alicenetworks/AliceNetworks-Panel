import{O,aF as Q,aG as W,aH as X}from"./index-ZJAELyGg.js";import{T as Y,E as Z}from"./TableSkeleton-CpNcW2pL.js";import{u as J}from"./useKeyboard-CbOLAjL8.js";import{u as R,f as ee,g as p,B as g,c as te,e as F}from"./naive-ui-B4L8VU6X.js";import{k as le,o as ae,Z as ne,Y as l,W as a,r as v,V as r,X as $,U as N,N as s,a2 as _,j as c,c as G,m as x}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const oe={class:"plans"},ce=le({__name:"Plans",setup(ue){const d=R(),V=ee(),y=v(!1),B=v(!1),k=v([]),m=v(!1),w=v(null),M=()=>({name:"",description:"",traffic_quota:0,speed_limit:0,duration:30,max_nodes:0,max_clients:0,enabled:!0,sort_order:0}),n=v(M()),z=G({get:()=>Math.round((n.value.traffic_quota||0)/(1024*1024*1024)),set:t=>{n.value.traffic_quota=t*1024*1024*1024}}),D=G({get:()=>Math.round((n.value.speed_limit||0)/125e3),set:t=>{n.value.speed_limit=t*125e3}}),h=t=>{if(!t||t===0)return"无限制";const e=["B","KB","MB","GB","TB"];let u=0,b=t;for(;b>=1024&&u<e.length-1;)b/=1024,u++;return`${b.toFixed(u===0?0:1)} ${e[u]}`},E=t=>{if(!t||t===0)return"不限速";const e=t/125e3;return e>=1e3?`${(e/1e3).toFixed(1)} Gbps`:`${e.toFixed(0)} Mbps`},S=t=>{if(!t||t===0)return"永久";if(t>=365){const e=Math.floor(t/365),u=t%365;return u===0?`${e} 年`:`${e} 年 ${u} 天`}if(t>=30){const e=Math.floor(t/30),u=t%30;return u===0?`${e} 个月`:`${e} 个月 ${u} 天`}return`${t} 天`},j=[{title:"ID",key:"id",width:60},{title:"套餐名称",key:"name",width:150},{title:"流量配额",key:"traffic_quota",width:120,render:t=>h(t.traffic_quota)},{title:"速度限制",key:"speed_limit",width:100,render:t=>E(t.speed_limit)},{title:"有效期",key:"duration",width:100,render:t=>S(t.duration)},{title:"资源限制",key:"limits",width:150,render:t=>{const e=t.max_nodes||"无限",u=t.max_clients||"无限";return x(te,{},{trigger:()=>`${e} 节点 / ${u} 客户端`,default:()=>`最大节点: ${e}, 最大客户端: ${u}`})}},{title:"用户数",key:"user_count",width:80,render:t=>x(F,{type:"info",size:"small"},()=>t.user_count||0)},{title:"状态",key:"enabled",width:80,render:t=>x(F,{type:t.enabled?"success":"default",size:"small"},()=>t.enabled?"启用":"禁用")},{title:"操作",key:"actions",width:150,render:t=>x(p,{size:"small"},()=>[x(g,{size:"small",onClick:()=>K(t)},()=>"编辑"),x(g,{size:"small",type:"error",onClick:()=>A(t),disabled:t.user_count>0},()=>"删除")])}],C=async()=>{y.value=!0;try{const t=await O();k.value=t||[]}catch{d.error("加载套餐失败")}finally{y.value=!1}},U=()=>{n.value=M(),w.value=null,m.value=!0},K=t=>{w.value=t,n.value={...M(),...t},m.value=!0},P=async()=>{if(!n.value.name){d.error("请输入套餐名称");return}B.value=!0;try{w.value?(await Q(w.value.id,n.value),d.success("套餐已更新")):(await W(n.value),d.success("套餐已创建")),m.value=!1,C()}catch(t){d.error(t.response?.data?.error||"保存套餐失败")}finally{B.value=!1}},A=t=>{if(t.user_count>0){d.error("该套餐正在被使用，无法删除");return}V.warning({title:"删除套餐",content:`确定要删除套餐 "${t.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await X(t.id),d.success("套餐已删除"),C()}catch(e){d.error(e.response?.data?.error||"删除套餐失败")}}})};return ae(()=>{C()}),J({onNew:U,modalVisible:m,onSave:P}),(t,e)=>{const u=r("n-data-table"),b=r("n-card"),q=r("n-input"),i=r("n-form-item"),T=r("n-divider"),f=r("n-input-number"),H=r("n-switch"),I=r("n-form"),L=r("n-modal");return $(),ne("div",oe,[l(b,null,{header:a(()=>[l(s(p),{justify:"space-between",align:"center"},{default:a(()=>[e[12]||(e[12]=_("span",null,"套餐管理",-1)),l(s(g),{type:"primary",onClick:U},{default:a(()=>[...e[11]||(e[11]=[c(" 添加套餐 ",-1)])]),_:1})]),_:1})]),default:a(()=>[y.value&&k.value.length===0?($(),N(Y,{key:0,rows:3,columns:[1,2,1,1,1]})):!y.value&&k.value.length===0?($(),N(Z,{key:1,type:"plans","action-text":"添加套餐",onAction:U})):($(),N(u,{key:2,columns:j,data:k.value,loading:y.value,"row-key":o=>o.id},null,8,["data","loading","row-key"]))]),_:1}),l(L,{show:m.value,"onUpdate:show":e[10]||(e[10]=o=>m.value=o),preset:"dialog",title:w.value?"编辑套餐":"添加套餐",style:{width:"600px"}},{action:a(()=>[l(s(p),null,{default:a(()=>[l(s(g),{onClick:e[9]||(e[9]=o=>m.value=!1)},{default:a(()=>[...e[21]||(e[21]=[c("取消",-1)])]),_:1}),l(s(g),{type:"primary",loading:B.value,onClick:P},{default:a(()=>[...e[22]||(e[22]=[c("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:a(()=>[l(I,{model:n.value,"label-placement":"left","label-width":"100"},{default:a(()=>[l(i,{label:"套餐名称"},{default:a(()=>[l(q,{value:n.value.name,"onUpdate:value":e[0]||(e[0]=o=>n.value.name=o),placeholder:"如: 基础版、专业版"},null,8,["value"])]),_:1}),l(i,{label:"套餐描述"},{default:a(()=>[l(q,{value:n.value.description,"onUpdate:value":e[1]||(e[1]=o=>n.value.description=o),type:"textarea",placeholder:"套餐功能说明",rows:2},null,8,["value"])]),_:1}),l(T,{"title-placement":"left"},{default:a(()=>[...e[13]||(e[13]=[c("配额限制",-1)])]),_:1}),l(i,{label:"流量配额"},{default:a(()=>[l(s(p),null,{default:a(()=>[l(f,{value:z.value,"onUpdate:value":e[2]||(e[2]=o=>z.value=o),min:0,max:102400,step:10,style:{width:"150px"},placeholder:"0"},null,8,["value"]),e[14]||(e[14]=_("span",null,"GB (0 = 无限制)",-1))]),_:1})]),_:1}),l(i,{label:"速度限制"},{default:a(()=>[l(s(p),null,{default:a(()=>[l(f,{value:D.value,"onUpdate:value":e[3]||(e[3]=o=>D.value=o),min:0,max:1e4,step:10,style:{width:"150px"},placeholder:"0"},null,8,["value"]),e[15]||(e[15]=_("span",null,"Mbps (0 = 不限速)",-1))]),_:1})]),_:1}),l(i,{label:"有效期"},{default:a(()=>[l(s(p),null,{default:a(()=>[l(f,{value:n.value.duration,"onUpdate:value":e[4]||(e[4]=o=>n.value.duration=o),min:0,max:3650,step:30,style:{width:"150px"},placeholder:"30"},null,8,["value"]),e[16]||(e[16]=_("span",null,"天 (0 = 永久)",-1))]),_:1})]),_:1}),l(T,{"title-placement":"left"},{default:a(()=>[...e[17]||(e[17]=[c("资源限制",-1)])]),_:1}),l(i,{label:"最大节点数"},{default:a(()=>[l(s(p),null,{default:a(()=>[l(f,{value:n.value.max_nodes,"onUpdate:value":e[5]||(e[5]=o=>n.value.max_nodes=o),min:0,max:1e3,style:{width:"150px"},placeholder:"0"},null,8,["value"]),e[18]||(e[18]=_("span",null,"(0 = 无限制)",-1))]),_:1})]),_:1}),l(i,{label:"最大客户端"},{default:a(()=>[l(s(p),null,{default:a(()=>[l(f,{value:n.value.max_clients,"onUpdate:value":e[6]||(e[6]=o=>n.value.max_clients=o),min:0,max:1e3,style:{width:"150px"},placeholder:"0"},null,8,["value"]),e[19]||(e[19]=_("span",null,"(0 = 无限制)",-1))]),_:1})]),_:1}),l(T,{"title-placement":"left"},{default:a(()=>[...e[20]||(e[20]=[c("其他设置",-1)])]),_:1}),l(i,{label:"排序顺序"},{default:a(()=>[l(f,{value:n.value.sort_order,"onUpdate:value":e[7]||(e[7]=o=>n.value.sort_order=o),min:0,max:999,style:{width:"150px"}},null,8,["value"])]),_:1}),l(i,{label:"启用套餐"},{default:a(()=>[l(H,{value:n.value.enabled,"onUpdate:value":e[8]||(e[8]=o=>n.value.enabled=o)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}});export{ce as default};
