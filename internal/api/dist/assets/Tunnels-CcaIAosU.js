import{ar as ue,i as de,as as re,at as pe,au as _e,av as fe,aw as ve,ax as me}from"./index-ZJAELyGg.js";import{T as ye,E as ce}from"./TableSkeleton-CpNcW2pL.js";import{u as ge,f as be,g as D,B as _,e as xe}from"./naive-ui-B4L8VU6X.js";import{k as ke,o as we,Z as Ce,Y as l,W as a,r as d,V as i,X as x,j as s,U as z,N as f,a2 as Te,a4 as K,c as H,m}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ue={class:"tunnels"},Oe=ke({__name:"Tunnels",setup($e){const u=ge(),I=be(),y=d(!1),k=d(!1),g=d([]),w=d([]),v=d(!1),C=d(!1),T=d(""),U=d(""),c=d(null),$=d(null),W=[{label:"TCP+UDP (端口复用)",value:"tcp+udp"},{label:"仅 TCP",value:"tcp"},{label:"仅 UDP",value:"udp"}],E=()=>({name:"",description:"",entry_node_id:null,entry_port:1e4,protocol:"tcp+udp",exit_node_id:null,target_addr:"",traffic_quota_gb:0,speed_limit_mbps:0,enabled:!0}),n=d(E()),X=H(()=>w.value.map(e=>({label:`${e.name} (${e.host}:${e.port})`,value:e.id}))),Y=H(()=>w.value.filter(e=>e.id!==n.value.entry_node_id).map(e=>({label:`${e.name} (${e.host}:${e.port}) - ${e.protocol}`,value:e.id}))),O=e=>{if(e===0)return"0 B";const t=1024,p=["B","KB","MB","GB","TB"],b=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,b)).toFixed(2))+" "+p[b]},Z=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"入口节点",key:"entry_node",width:150,render:e=>e.entry_node?.name||"-"},{title:"监听",key:"entry_port",width:130,render:e=>`:${e.entry_port} (${e.protocol||"tcp+udp"})`},{title:"出口节点",key:"exit_node",width:150,render:e=>e.exit_node?.name||"-"},{title:"目标",key:"target_addr",width:150,render:e=>e.target_addr||"代理模式"},{title:"流量",key:"traffic",width:120,render:e=>`↑${O(e.traffic_out)} ↓${O(e.traffic_in)}`},{title:"状态",key:"enabled",width:80,render:e=>m(xe,{type:e.enabled?"success":"default",size:"small"},()=>e.enabled?"启用":"禁用")},{title:"操作",key:"actions",width:280,render:e=>m(D,{size:"small"},()=>[m(_,{size:"small",onClick:()=>R(e)},()=>"编辑"),m(_,{size:"small",type:"primary",onClick:()=>L(e)},()=>"同步"),m(_,{size:"small",type:"info",onClick:()=>le(e)},()=>"配置"),m(_,{size:"small",type:"error",onClick:()=>te(e)},()=>"删除")])}],P=d(null),L=async e=>{P.value=e.id;try{const t=await _e(e.id);u.success(t.message||"同步成功")}catch(t){u.error(t.response?.data?.message||t.response?.data?.error||"同步失败")}finally{P.value=null}},B=async()=>{y.value=!0;try{const e=await ue();g.value=e||[]}catch{u.error("加载隧道列表失败")}finally{y.value=!1}},Q=async()=>{try{const e=await de();w.value=e||[]}catch(e){console.error("Failed to load nodes",e)}},h=()=>{n.value=E(),c.value=null,v.value=!0},R=e=>{c.value=e,n.value={name:e.name,description:e.description||"",entry_node_id:e.entry_node_id,entry_port:e.entry_port,protocol:e.protocol||"tcp",exit_node_id:e.exit_node_id,target_addr:e.target_addr||"",traffic_quota_gb:e.traffic_quota?e.traffic_quota/(1024*1024*1024):0,speed_limit_mbps:e.speed_limit?e.speed_limit/(1024*1024/8):0,enabled:e.enabled},v.value=!0},ee=async()=>{if(!n.value.name){u.error("请输入名称");return}if(!n.value.entry_node_id){u.error("请选择入口节点");return}if(!n.value.exit_node_id){u.error("请选择出口节点");return}k.value=!0;try{const e={...n.value,traffic_quota:Math.round(n.value.traffic_quota_gb*1024*1024*1024),speed_limit:Math.round(n.value.speed_limit_mbps*1024*1024/8)};delete e.traffic_quota_gb,delete e.speed_limit_mbps,c.value?(await re(c.value.id,e),u.success("隧道已更新")):(await pe(e),u.success("隧道已创建")),v.value=!1,B()}catch(e){u.error(e.response?.data?.error||"保存失败")}finally{k.value=!1}},te=e=>{I.warning({title:"删除隧道",content:`确定要删除隧道 "${e.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await fe(e.id),u.success("隧道已删除"),B()}catch{u.error("删除失败")}}})},le=async e=>{$.value=e;try{const[t,p]=await Promise.all([ve(e.id),me(e.id)]);T.value=typeof t=="string"?t:JSON.stringify(t,null,2),U.value=typeof p=="string"?p:JSON.stringify(p,null,2),C.value=!0}catch{u.error("获取配置失败")}},F=e=>{navigator.clipboard.writeText(e),u.success("已复制到剪贴板")};return we(()=>{B(),Q()}),(e,t)=>{const p=i("n-alert"),b=i("n-data-table"),ae=i("n-card"),q=i("n-input"),r=i("n-form-item"),M=i("n-divider"),N=i("n-select"),S=i("n-input-number"),V=i("n-grid-item"),ne=i("n-grid"),oe=i("n-switch"),ie=i("n-form"),G=i("n-modal"),j=i("n-code"),A=i("n-scrollbar"),J=i("n-tab-pane"),se=i("n-tabs");return x(),Ce("div",Ue,[l(ae,null,{header:a(()=>[l(f(D),{justify:"space-between",align:"center"},{default:a(()=>[t[16]||(t[16]=Te("span",null,"隧道转发",-1)),l(f(_),{type:"primary",onClick:h},{default:a(()=>[...t[15]||(t[15]=[s(" 添加隧道 ",-1)])]),_:1})]),_:1})]),default:a(()=>[l(p,{type:"info",style:{"margin-bottom":"16px"}},{default:a(()=>[...t[17]||(t[17]=[s(" 隧道转发：用户 → 入口节点(A) → 出口节点(B) → 目标网站。入口节点监听端口，流量通过出口节点转发。 ",-1)])]),_:1}),y.value&&g.value.length===0?(x(),z(ye,{key:0,rows:3})):!y.value&&g.value.length===0?(x(),z(ce,{key:1,type:"tunnels","action-text":"添加隧道",onAction:h})):(x(),z(b,{key:2,columns:Z,data:g.value,loading:y.value,"row-key":o=>o.id},null,8,["data","loading","row-key"]))]),_:1}),l(G,{show:v.value,"onUpdate:show":t[11]||(t[11]=o=>v.value=o),preset:"dialog",title:c.value?"编辑隧道":"添加隧道",style:{width:"650px"}},{action:a(()=>[l(f(D),null,{default:a(()=>[l(f(_),{onClick:t[10]||(t[10]=o=>v.value=!1)},{default:a(()=>[...t[25]||(t[25]=[s("取消",-1)])]),_:1}),l(f(_),{type:"primary",loading:k.value,onClick:ee},{default:a(()=>[...t[26]||(t[26]=[s("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:a(()=>[l(ie,{model:n.value,"label-placement":"left","label-width":"100"},{default:a(()=>[l(r,{label:"名称",required:""},{default:a(()=>[l(q,{value:n.value.name,"onUpdate:value":t[0]||(t[0]=o=>n.value.name=o),placeholder:"例如: HK-US隧道"},null,8,["value"])]),_:1}),l(r,{label:"描述"},{default:a(()=>[l(q,{value:n.value.description,"onUpdate:value":t[1]||(t[1]=o=>n.value.description=o),placeholder:"隧道用途说明"},null,8,["value"])]),_:1}),l(M,null,{default:a(()=>[...t[18]||(t[18]=[s("入口端配置",-1)])]),_:1}),l(r,{label:"入口节点",required:""},{default:a(()=>[l(N,{value:n.value.entry_node_id,"onUpdate:value":t[2]||(t[2]=o=>n.value.entry_node_id=o),options:X.value,placeholder:"选择入口节点 (用户连接的节点)",filterable:""},null,8,["value","options"])]),_:1}),l(r,{label:"监听端口",required:""},{default:a(()=>[l(S,{value:n.value.entry_port,"onUpdate:value":t[3]||(t[3]=o=>n.value.entry_port=o),min:1,max:65535,style:{width:"200px"}},{suffix:a(()=>[...t[19]||(t[19]=[s("端口",-1)])]),_:1},8,["value"])]),_:1}),l(r,{label:"协议"},{default:a(()=>[l(N,{value:n.value.protocol,"onUpdate:value":t[4]||(t[4]=o=>n.value.protocol=o),options:W,style:{width:"200px"}},null,8,["value"])]),_:1}),l(M,null,{default:a(()=>[...t[20]||(t[20]=[s("出口端配置",-1)])]),_:1}),l(r,{label:"出口节点",required:""},{default:a(()=>[l(N,{value:n.value.exit_node_id,"onUpdate:value":t[5]||(t[5]=o=>n.value.exit_node_id=o),options:Y.value,placeholder:"选择出口节点 (落地节点)",filterable:""},null,8,["value","options"])]),_:1}),l(r,{label:"目标地址"},{default:a(()=>[l(q,{value:n.value.target_addr,"onUpdate:value":t[6]||(t[6]=o=>n.value.target_addr=o),placeholder:"留空则使用代理模式，填写则为端口转发 (如 8.8.8.8:53)"},{prefix:a(()=>[...t[21]||(t[21]=[s("可选",-1)])]),_:1},8,["value"])]),_:1}),l(M,null,{default:a(()=>[...t[22]||(t[22]=[s("限制配置",-1)])]),_:1}),l(ne,{cols:2,"x-gap":12},{default:a(()=>[l(V,null,{default:a(()=>[l(r,{label:"流量配额"},{default:a(()=>[l(S,{value:n.value.traffic_quota_gb,"onUpdate:value":t[7]||(t[7]=o=>n.value.traffic_quota_gb=o),min:0,precision:2,style:{width:"100%"}},{suffix:a(()=>[...t[23]||(t[23]=[s("GB",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),l(V,null,{default:a(()=>[l(r,{label:"限速"},{default:a(()=>[l(S,{value:n.value.speed_limit_mbps,"onUpdate:value":t[8]||(t[8]=o=>n.value.speed_limit_mbps=o),min:0,precision:2,style:{width:"100%"}},{suffix:a(()=>[...t[24]||(t[24]=[s("Mbps",-1)])]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),l(r,{label:"启用"},{default:a(()=>[l(oe,{value:n.value.enabled,"onUpdate:value":t[9]||(t[9]=o=>n.value.enabled=o)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(G,{show:C.value,"onUpdate:show":t[14]||(t[14]=o=>C.value=o),preset:"dialog",title:"GOST 配置",style:{width:"800px"}},{default:a(()=>[l(se,{type:"line"},{default:a(()=>[l(J,{name:"entry",tab:"入口端配置"},{default:a(()=>[l(p,{type:"info",style:{"margin-bottom":"12px"}},{default:a(()=>[s(" 将此配置部署到入口节点 ("+K($.value?.entry_node?.name||"入口节点")+") ",1)]),_:1}),l(A,{style:{"max-height":"350px"}},{default:a(()=>[l(j,{code:T.value,language:"yaml","word-wrap":""},null,8,["code"])]),_:1}),l(f(_),{style:{"margin-top":"12px"},onClick:t[12]||(t[12]=o=>F(T.value))},{default:a(()=>[...t[27]||(t[27]=[s("复制入口配置",-1)])]),_:1})]),_:1}),l(J,{name:"exit",tab:"出口端配置"},{default:a(()=>[l(p,{type:"info",style:{"margin-bottom":"12px"}},{default:a(()=>[s(" 将此配置部署到出口节点 ("+K($.value?.exit_node?.name||"出口节点")+") ",1)]),_:1}),l(A,{style:{"max-height":"350px"}},{default:a(()=>[l(j,{code:U.value,language:"yaml","word-wrap":""},null,8,["code"])]),_:1}),l(f(_),{style:{"margin-top":"12px"},onClick:t[13]||(t[13]=o=>F(U.value))},{default:a(()=>[...t[28]||(t[28]=[s("复制出口配置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])])}}});export{Oe as default};
