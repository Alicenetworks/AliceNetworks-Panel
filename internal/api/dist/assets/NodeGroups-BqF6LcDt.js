import{ab as fe,i as ce,ac as ye,ad as he,ae as ge,af as we,ag as _e,ah as be,ai as ke}from"./index-ZJAELyGg.js";import{T as xe,E as Ce}from"./TableSkeleton-CpNcW2pL.js";import{u as Ne,f as Me,g as c,B as d,e as R}from"./naive-ui-B4L8VU6X.js";import{k as ze,o as Ue,Z as Y,Y as t,W as a,r as s,V as r,X as x,U as V,N as i,a2 as U,j as m,F as Ge,_ as Se,c as D,m as f}from"./vue-vendor-CGi32OHI.js";import"./index-3OKNQTir.js";import"./SwapHorizontalOutline-BSqMGymv.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Te={class:"node-groups"},Pe=ze({__name:"NodeGroups",setup($e){const u=Ne(),E=Me(),g=s(!1),G=s(!1),S=s(!1),T=s(!1),C=s([]),$=s([]),P=s([]),y=s(!1),N=s(!1),w=s(!1),B=s(!1),I=s(""),_=s(null),h=s(null),j=[{label:"轮询 (Round Robin)",value:"round_robin"},{label:"随机 (Random)",value:"random"},{label:"加权轮询 (Weighted)",value:"weighted"},{label:"最少连接 (Least Conn)",value:"least_conn"},{label:"哈希 (Hash)",value:"hash"},{label:"IP 哈希 (IP Hash)",value:"ip_hash"}],A=()=>({name:"",strategy:"round_robin",health_check_enabled:!0,health_check_interval:3e4,health_check_timeout:5e3,max_fails:3,description:""}),o=s(A()),v=s({node_id:null,weight:1,priority:1}),H=D({get:()=>o.value.health_check_interval/1e3,set:l=>{o.value.health_check_interval=l*1e3}}),L=D({get:()=>o.value.health_check_timeout/1e3,set:l=>{o.value.health_check_timeout=l*1e3}}),Z=D(()=>{const l=new Set($.value.map(e=>e.node_id));return P.value.filter(e=>!l.has(e.id)).map(e=>({label:`${e.name} (${e.host}:${e.port})`,value:e.id}))}),q=l=>{const e=j.find(M=>M.value===l);return e?e.label:l},Q=[{title:"ID",key:"id",width:60},{title:"组名",key:"name",width:150},{title:"策略",key:"strategy",width:180,render:l=>f(R,{type:"info",size:"small"},()=>q(l.strategy))},{title:"健康检查",key:"health_check_enabled",width:100,render:l=>f(R,{type:l.health_check_enabled?"success":"default",size:"small"},()=>l.health_check_enabled?"启用":"禁用")},{title:"节点数量",key:"node_count",width:100},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"操作",key:"actions",width:260,render:l=>f(c,{size:"small"},()=>[f(d,{size:"small",onClick:()=>te(l)},()=>"编辑"),f(d,{size:"small",type:"primary",onClick:()=>oe(l)},()=>"管理节点"),f(d,{size:"small",onClick:()=>de(l)},()=>"配置"),f(d,{size:"small",type:"error",onClick:()=>ne(l)},()=>"删除")])}],ee=[{title:"ID",key:"id",width:60},{title:"节点名称",key:"node_name",width:150},{title:"地址",key:"node_host"},{title:"权重",key:"weight",width:80},{title:"优先级",key:"priority",width:80},{title:"状态",key:"node_status",width:80,render:l=>f(R,{type:l.node_status==="online"?"success":"default",size:"small"},()=>l.node_status==="online"?"在线":"离线")},{title:"操作",key:"actions",width:100,render:l=>f(d,{size:"small",type:"error",onClick:()=>ie(l)},()=>"移除")}],b=async()=>{g.value=!0;try{const l=await fe();C.value=l||[]}catch{u.error("加载节点组失败")}finally{g.value=!1}},le=async()=>{try{const l=await ce();P.value=l||[]}catch(l){console.error("Failed to load nodes",l)}},O=()=>{o.value=A(),_.value=null,y.value=!0},te=l=>{_.value=l,o.value={...A(),...l},y.value=!0},ae=async()=>{if(!o.value.name){u.error("请输入组名");return}G.value=!0;try{_.value?(await ye(_.value.id,o.value),u.success("节点组已更新")):(await he(o.value),u.success("节点组已创建")),y.value=!1,b()}catch(l){u.error(l.response?.data?.error||"保存节点组失败")}finally{G.value=!1}},ne=l=>{E.warning({title:"删除节点组",content:`确定要删除节点组 "${l.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await be(l.id),u.success("节点组已删除"),b()}catch{u.error("删除节点组失败")}}})},oe=async l=>{h.value=l,N.value=!0,await F(l.id)},F=async l=>{S.value=!0;try{const e=await we(l);$.value=e||[]}catch{u.error("加载节点成员失败")}finally{S.value=!1}},se=()=>{v.value={node_id:null,weight:1,priority:1},w.value=!0},ue=async()=>{if(!v.value.node_id){u.error("请选择节点");return}T.value=!0;try{await ge(h.value.id,v.value),u.success("节点已添加到组"),w.value=!1,await F(h.value.id),await b()}catch(l){u.error(l.response?.data?.error||"添加节点失败")}finally{T.value=!1}},ie=l=>{E.warning({title:"移除节点",content:`确定要从组中移除节点 "${l.node_name}" 吗？`,positiveText:"移除",negativeText:"取消",onPositiveClick:async()=>{try{await _e(h.value.id,l.id),u.success("节点已移除"),await F(h.value.id),await b()}catch{u.error("移除节点失败")}}})},de=async l=>{try{const e=await ke(l.id);I.value=typeof e=="string"?e:JSON.stringify(e,null,2),B.value=!0}catch{u.error("获取配置失败")}},re=()=>{navigator.clipboard.writeText(I.value),u.success("已复制到剪贴板")};return Ue(()=>{b(),le()}),(l,e)=>{const M=r("n-data-table"),ve=r("n-card"),W=r("n-input"),p=r("n-form-item"),J=r("n-select"),pe=r("n-switch"),k=r("n-input-number"),K=r("n-form"),z=r("n-modal"),X=r("n-text"),me=r("n-code");return x(),Y("div",Te,[t(ve,null,{header:a(()=>[t(i(c),{justify:"space-between",align:"center"},{default:a(()=>[e[18]||(e[18]=U("span",null,"节点组 / 负载均衡",-1)),t(i(d),{type:"primary",onClick:O},{default:a(()=>[...e[17]||(e[17]=[m(" 添加节点组 ",-1)])]),_:1})]),_:1})]),default:a(()=>[g.value&&C.value.length===0?(x(),V(xe,{key:0,rows:3})):!g.value&&C.value.length===0?(x(),V(Ce,{key:1,type:"groups","action-text":"添加节点组",onAction:O})):(x(),V(M,{key:2,columns:Q,data:C.value,loading:g.value,"row-key":n=>n.id},null,8,["data","loading","row-key"]))]),_:1}),t(z,{show:y.value,"onUpdate:show":e[8]||(e[8]=n=>y.value=n),preset:"dialog",title:_.value?"编辑节点组":"添加节点组",style:{width:"600px"}},{action:a(()=>[t(i(c),null,{default:a(()=>[t(i(d),{onClick:e[7]||(e[7]=n=>y.value=!1)},{default:a(()=>[...e[21]||(e[21]=[m("取消",-1)])]),_:1}),t(i(d),{type:"primary",loading:G.value,onClick:ae},{default:a(()=>[...e[22]||(e[22]=[m("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:a(()=>[t(K,{model:o.value,"label-placement":"left","label-width":"120"},{default:a(()=>[t(p,{label:"组名"},{default:a(()=>[t(W,{value:o.value.name,"onUpdate:value":e[0]||(e[0]=n=>o.value.name=n),placeholder:"例如: HK-Group"},null,8,["value"])]),_:1}),t(p,{label:"负载均衡策略"},{default:a(()=>[t(J,{value:o.value.strategy,"onUpdate:value":e[1]||(e[1]=n=>o.value.strategy=n),options:j},null,8,["value"])]),_:1}),t(p,{label:"健康检查"},{default:a(()=>[t(pe,{value:o.value.health_check_enabled,"onUpdate:value":e[2]||(e[2]=n=>o.value.health_check_enabled=n)},null,8,["value"])]),_:1}),o.value.health_check_enabled?(x(),Y(Ge,{key:0},[t(p,{label:"检查间隔"},{default:a(()=>[t(i(c),null,{default:a(()=>[t(k,{value:H.value,"onUpdate:value":e[3]||(e[3]=n=>H.value=n),min:10,style:{width:"120px"}},null,8,["value"]),e[19]||(e[19]=U("span",null,"秒",-1))]),_:1})]),_:1}),t(p,{label:"检查超时"},{default:a(()=>[t(i(c),null,{default:a(()=>[t(k,{value:L.value,"onUpdate:value":e[4]||(e[4]=n=>L.value=n),min:1,style:{width:"120px"}},null,8,["value"]),e[20]||(e[20]=U("span",null,"秒",-1))]),_:1})]),_:1}),t(p,{label:"最大失败次数"},{default:a(()=>[t(k,{value:o.value.max_fails,"onUpdate:value":e[5]||(e[5]=n=>o.value.max_fails=n),min:1,style:{width:"120px"}},null,8,["value"])]),_:1})],64)):Se("",!0),t(p,{label:"描述"},{default:a(()=>[t(W,{value:o.value.description,"onUpdate:value":e[6]||(e[6]=n=>o.value.description=n),type:"textarea",placeholder:"节点组描述",autosize:{minRows:2}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),t(z,{show:N.value,"onUpdate:show":e[10]||(e[10]=n=>N.value=n),preset:"dialog",title:`管理节点组: ${h.value?.name}`,style:{width:"800px"}},{action:a(()=>[t(i(d),{onClick:e[9]||(e[9]=n=>N.value=!1)},{default:a(()=>[...e[25]||(e[25]=[m("关闭",-1)])]),_:1})]),default:a(()=>[t(i(c),{vertical:"",size:"large"},{default:a(()=>[t(i(c),{justify:"space-between",align:"center"},{default:a(()=>[e[24]||(e[24]=U("span",null,"节点成员",-1)),t(i(d),{type:"primary",size:"small",onClick:se},{default:a(()=>[...e[23]||(e[23]=[m(" 添加节点 ",-1)])]),_:1})]),_:1}),t(M,{columns:ee,data:$.value,loading:S.value,"row-key":n=>n.id,size:"small","max-height":"400"},null,8,["data","loading","row-key"])]),_:1})]),_:1},8,["show","title"]),t(z,{show:w.value,"onUpdate:show":e[15]||(e[15]=n=>w.value=n),preset:"dialog",title:"添加节点成员",style:{width:"500px"}},{action:a(()=>[t(i(c),null,{default:a(()=>[t(i(d),{onClick:e[14]||(e[14]=n=>w.value=!1)},{default:a(()=>[...e[28]||(e[28]=[m("取消",-1)])]),_:1}),t(i(d),{type:"primary",loading:T.value,onClick:ue},{default:a(()=>[...e[29]||(e[29]=[m("添加",-1)])]),_:1},8,["loading"])]),_:1})]),default:a(()=>[t(K,{model:v.value,"label-placement":"left","label-width":"100"},{default:a(()=>[t(p,{label:"选择节点"},{default:a(()=>[t(J,{value:v.value.node_id,"onUpdate:value":e[11]||(e[11]=n=>v.value.node_id=n),options:Z.value,filterable:"",placeholder:"选择要添加的节点"},null,8,["value","options"])]),_:1}),t(p,{label:"权重"},{default:a(()=>[t(k,{value:v.value.weight,"onUpdate:value":e[12]||(e[12]=n=>v.value.weight=n),min:1,max:100,style:{width:"120px"}},null,8,["value"]),t(X,{depth:"3",style:{"margin-left":"12px","font-size":"12px"}},{default:a(()=>[...e[26]||(e[26]=[m("数值越大，流量分配越多",-1)])]),_:1})]),_:1}),t(p,{label:"优先级"},{default:a(()=>[t(k,{value:v.value.priority,"onUpdate:value":e[13]||(e[13]=n=>v.value.priority=n),min:1,max:10,style:{width:"120px"}},null,8,["value"]),t(X,{depth:"3",style:{"margin-left":"12px","font-size":"12px"}},{default:a(()=>[...e[27]||(e[27]=[m("数值越小，优先级越高",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show"]),t(z,{show:B.value,"onUpdate:show":e[16]||(e[16]=n=>B.value=n),preset:"dialog",title:"负载均衡配置",style:{width:"700px"}},{action:a(()=>[t(i(d),{onClick:re},{default:a(()=>[...e[30]||(e[30]=[m("复制",-1)])]),_:1})]),default:a(()=>[t(me,{code:I.value,language:"yaml",style:{"max-height":"500px",overflow:"auto"}},null,8,["code"])]),_:1},8,["show"])])}}});export{Pe as default};
